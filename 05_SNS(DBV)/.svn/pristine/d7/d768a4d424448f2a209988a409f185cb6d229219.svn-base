//
//  CertViewController.m
//  mfinity_sns
//
//  Created by hilee on 2017. 3. 7..
//  Copyright © 2017년 com.dbvalley. All rights reserved.
//

#import "CertViewController.h"
#import "RMQServerViewController.h"
#import "IntroViewController.h"
#import "MFStyle.h"

@interface CertViewController (){
    RMQServerViewController *rmq;
}

@end

@implementation CertViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
    //self.navigationItem.hidesBackButton = YES;
    
    isHideKeyboard = YES;
    
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(keyboardWillAnimate:) name:UIKeyboardWillShowNotification object:nil];
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(keyboardWillAnimate:) name:UIKeyboardWillHideNotification object:nil];
    
    self.compTextField.placeholder = NSLocalizedString(@"msg9", @"");
    [self.compTextField setAutocorrectionType:UITextAutocorrectionTypeNo];
    
    self.authTextField.placeholder = NSLocalizedString(@"msg10", @"");
    //self.navigationController.navigationBar.barTintColor = [MFUtil myRGBfromHex:@"1D4696"];
    UIView *statusBar = [[[UIApplication sharedApplication] valueForKey:@"statusBarWindow"] valueForKey:@"statusBar"];
    statusBar.backgroundColor = [MFUtil myRGBfromHex:@"1D4696"];
    self.navigationController.navigationBar.backgroundColor = [MFUtil myRGBfromHex:@"1D4696"];
    self.navigationController.navigationBar.tintColor = [UIColor whiteColor];
    self.navigationItem.titleView = [MFStyle navigationTitleStyle1:NSLocalizedString(@"msg12", @"")];
    
}

- (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event {
    [self.view endEditing:YES];
}


- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

- (IBAction)authenticate:(id)sender {
    if([self.authTextField.text isEqualToString:@""]){
        UIAlertView *alert = [[UIAlertView alloc]initWithTitle:NSLocalizedString(@"msg13", @"")
                                                 message:NSLocalizedString(@"msg14", @"")
                                                 delegate:self cancelButtonTitle:NSLocalizedString(@"msg3", @"") otherButtonTitles:nil, nil];
        [alert show];
    } else {
        [self auth];
    }
}

- (void)auth {
    AppDelegate *appDelegate = (AppDelegate *)[UIApplication sharedApplication].delegate;
    UIDevice *device = [UIDevice currentDevice];
    CTTelephonyNetworkInfo *networkInfo = [[CTTelephonyNetworkInfo alloc] init];
    CTCarrier *ctCarrier = [networkInfo subscriberCellularProvider];
    NSLog(@"Carrier Name: %@", [ctCarrier carrierName]);
    //총 용량
    float totalSpace = 0.0f;
    NSString *totalVolume;
    NSError *error = nil;
    NSArray *paths = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES);
    NSDictionary *dictionary = [[NSFileManager defaultManager] attributesOfFileSystemForPath:[paths lastObject] error:&error];
    if (dictionary) {
        NSNumber *fileSystemSizeInBytes = [dictionary objectForKey:NSFileSystemSize];
        totalSpace = [fileSystemSizeInBytes floatValue];
        totalVolume = [NSString stringWithFormat:@"%0.0f",totalSpace];
        //totalSpace = ((totalSpace/1024)/1024)/1024;
    }
    //사용 용량
    float availableDisk;
    NSArray *path = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES);
    struct statfs tStats;
    statfs([[path lastObject] UTF8String], &tStats);
    availableDisk = (float)(tStats.f_bavail * tStats.f_bsize);
    
    NSString *dvcID = [[NSUserDefaults standardUserDefaults] objectForKey:@"DVC_ID"];//[MFUtil getUUID];
    NSString *dvcKind = [device modelName];
    NSString *dvcOS = device.systemName;
    NSString *dvcVer = device.systemVersion;
    NSString *carrier = [ctCarrier carrierName]; if(carrier==nil)carrier = @"-";
    NSString *extRam = @"N";
    NSString *extTotVol = @"0";
    NSString *extUseVol = @"0";
    NSString *useVol = [NSString stringWithFormat:@"%0.0f",availableDisk];

    NSString *pushID1 = [[NSUserDefaults standardUserDefaults] objectForKey:@"PUSH_ID1"]; //appDelegate.appDeviceToken2;
    NSString *pushID2 = @"-";
    NSString *isRooted = [MFUtil isRooted]?@"Y":@"N";
    NSString *authCode = self.authTextField.text;
#if TARGET_IPHONE_SIMULATOR
    isRooted = @"N";
#endif
    
    NSString *paramString = [NSString stringWithFormat:@"dvcId=%@&dvcKind=%@&dvcOs=%@&dvcVer=%@&carrier=%@&extRam=%@&extTotVol=%@&extUseVol=%@&useVol=%@&pushId1=%@&pushId2=%@&isRooted=%@&usrId=%@&authCode=%@"
                             ,dvcID
                             ,dvcKind
                             ,dvcOS
                             ,dvcVer
                             ,carrier
                             ,extRam
                             ,extTotVol
                             ,extUseVol
                             ,useVol
                             ,pushID1
                             ,pushID2
                             ,isRooted
                             ,self.userID
                             ,authCode];
    
    NSLog(@"paramString : %@",paramString);
    
    NSString *urlString = appDelegate.main_url;
    NSURL *url = [NSURL URLWithString:[urlString stringByAppendingPathComponent:@"chkDvcAuth"]];
    MFURLSession *session = [[MFURLSession alloc]initWithURL:url option:paramString];
    session.delegate = self;
    if ([session start]) {
        [SVProgressHUD show];
    }
    
}

- (void)returnDataWithObject:(MFURLSession *)session error:(NSString *)error {
    NSLog(@"%s",__func__);
    
    [SVProgressHUD dismiss];
    if (error==nil) {
        if ([[session.returnDictionary objectForKey:@"RESULT"] isEqualToString:@"SUCCESS"]) {
            if(([[session.returnDictionary objectForKey:@"AFFECTED"] intValue]>0)){
                NSUserDefaults *prefs = [NSUserDefaults standardUserDefaults];
                [prefs setObject:self.userID forKey:@"USER_ID"];
                [prefs setObject:self.userPwd forKey:@"USER_PWD"];
                [prefs setObject:self.userID forKey:@"DB_NAME"];
                [prefs synchronize];
                //NSLog(@"Cert returnDictionary : %@", session.returnDictionary);
                
                //NSLog(@"IntroViewController : %@", [[self.parentViewController childViewControllers] objectAtIndex:0]);
                [self performSegueWithIdentifier:@"INTRO_VIEW_PUSH" sender:self];
                
            }else{
                UIAlertView *alert = [[UIAlertView alloc]initWithTitle:NSLocalizedString(@"msg13", @"")
                                                         message:NSLocalizedString(@"msg15", @"")
                                                         delegate:self cancelButtonTitle:NSLocalizedString(@"msg3", @"") otherButtonTitles:nil, nil];
                [alert show];
            }
            
        }else{
            UIAlertView *alert = [[UIAlertView alloc]initWithTitle:NSLocalizedString(@"msg13", @"")
                                                     message:[session.returnDictionary objectForKey:@"MESSAGE"]
                                                     delegate:self cancelButtonTitle:NSLocalizedString(@"msg3", @"") otherButtonTitles:nil, nil];
            [alert show];
        }
    }else{
        UIAlertView *alert = [[UIAlertView alloc]initWithTitle:NSLocalizedString(@"msg13", @"") message:error delegate:self
                                                 cancelButtonTitle:NSLocalizedString(@"msg3", @"") otherButtonTitles:nil, nil];
        [alert show];
    }
}

/*
- (void)certConnectServer :(NSDictionary *)dataSet {
    NSLog(@"%s", __func__);
    
    AppDelegate *appDelegate = (AppDelegate *)[UIApplication sharedApplication].delegate;
    NSString *compNo = [[NSUserDefaults standardUserDefaults] objectForKey:@"COMP_NO"];
    
    NSArray *snsList = [dataSet objectForKey:@"SNS_LIST"];
    for(int i=0; i<snsList.count; i++){
        NSNumber *snsNo = [[snsList objectAtIndex:i]objectForKey:@"SNS_NO"];
        
        [appDelegate.bindQueueArr addObject:[NSString stringWithFormat:@"BOARD.POST.%@.%@", compNo, snsNo]];
        [appDelegate.bindQueueArr addObject:[NSString stringWithFormat:@"BOARD.COMMENT.%@.%@", compNo, snsNo]];
    }
    
    NSDictionary *dic = [NSDictionary dictionaryWithObject:appDelegate.bindQueueArr forKey:@"ROUTING_KEY"];
    [[NSNotificationCenter defaultCenter] postNotificationName:@"noti_RmqConnect" object:nil userInfo:dic];
}
*/

- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {

}

- (void)keyboardWillAnimate:(NSNotification *)notification{
    CGRect keyboardBounds;
    [[notification.userInfo valueForKey:UIKeyboardFrameEndUserInfoKey] getValue:&keyboardBounds];
    NSNumber *duration = [notification.userInfo objectForKey:UIKeyboardAnimationDurationUserInfoKey];
    NSNumber *curve = [notification.userInfo objectForKey:UIKeyboardAnimationCurveUserInfoKey];
    
    keyboardBounds = [self.view convertRect:keyboardBounds toView:nil];
    [UIView beginAnimations:nil context:NULL];
    [UIView setAnimationDuration:[duration doubleValue]];
    [UIView setAnimationCurve:[curve intValue]];
    
    if ([notification name]==UIKeyboardWillShowNotification) {
        if(isHideKeyboard){
            [self.view setFrame:CGRectMake(self.view.frame.origin.x, self.view.frame.origin.y - 50, self.view.frame.size.width, self.view.frame.size.height)];
            isHideKeyboard = NO;
        }
    }else if([notification name]==UIKeyboardWillHideNotification){
        [self.view setFrame:CGRectMake(self.view.frame.origin.x, self.view.frame.origin.y + 50,self.view.frame.size.width, self.view.frame.size.height)];
        isHideKeyboard = YES;
    }
    [UIView commitAnimations];
}
- (void)_removeKeyboardNotification {
    [[NSNotificationCenter defaultCenter] removeObserver:self name:UIKeyboardWillShowNotification object:nil];
    [[NSNotificationCenter defaultCenter] removeObserver:self name:UIKeyboardWillHideNotification object:nil];
}

@end
