//
//  CollectionViewController.m
//  mfinity_sns
//
//  Created by hilee on 2017. 3. 7..
//  Copyright © 2017년 com.dbvalley. All rights reserved.
//

#import "CollectionViewController.h"
#import "PostDetailViewController.h"
#import "MFStyle.h"
#import "CollectionViewCell.h"
#import "ProjectCollectionViewCell.h"
#import "TaskDetailViewController.h"
#import "TaskWriteViewController.h"

#import "CustomHeaderViewController.h"

#define LABEL_DEFAULT_HEIGHT            21.f
#define LABEL_DEFAUlT_WIDTH             280.f
#define LABEL_MAX_HEIGHT                460.f

#define ROW_TAG 1000

#define REFRESH_TABLEVIEW_DEFAULT_ROW               64.f
#define REFRESH_HEADER_DEFAULT_HEIGHT               64.f
#define REFRESH_TITLE_TABLE_PULL                    @"당겼다 놔주세요."
#define REFRESH_TITLE_TABLE_RELEASE                 @"당겼다 놔주세요."
#define REFRESH_TITLE_TABLE_LOAD                    @"새로고치는 중..."
#define REFRESH_TIME_FORMAT                         @"MM/dd (HH:mm:ss)"

#define kSupplementaryViewID @"SUP_VIEW_ID"
#define MODEL_NAME [[UIDevice currentDevice] modelName]

@interface CollectionViewController () {
    BOOL isError;
    AppDelegate *appDelegate;
    int initKind;
}

@property (strong, nonatomic) VCFloatingActionButton *addButton;

@end

@implementation CollectionViewController

static NSString * const reuseIdentifier = @"CELL";

- (void)viewDidLoad {
    [super viewDidLoad];
    
    //[self.collectionView registerNib:[UINib nibWithNibName:@"CollectionViewCell" bundle:nil] forCellWithReuseIdentifier:@"CollectionViewCell"];
    
    //[[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(noti_TeamProfileChat:) name:@"noti_TeamProfileChat" object:nil];
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(noti_FeedProfileChat:) name:@"noti_FeedProfileChat" object:nil];
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(noti_NewChatPush:) name:@"noti_NewChatPush" object:nil];
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(noti_ForceDeleteSNS:) name:@"noti_ForceDeleteSNS" object:nil];
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(noti_RefreshFeed:) name:@"noti_RefreshFeed" object:nil];
    
    refreshTime = @"";
    isError = NO;
    
    self.navigationController.navigationBar.translucent = NO;
    self.navigationController.navigationBar.barTintColor = [MFUtil myRGBfromHex:@"1D4696"];
    self.navigationController.navigationBar.tintColor = [UIColor whiteColor];
    
    //    UIButton *right1 = [[UIButton alloc]initWithFrame:CGRectMake(0, 0, 40, 40)];
    //    [right1 setImage:[self getScaledImage:[UIImage imageNamed:@"btn_add.png"] scaledToMaxWidth:20] forState:UIControlStateNormal];
    //    [right1 addTarget:self action:@selector(createPost:) forControlEvents:UIControlEventTouchUpInside];
    //    UIBarButtonItem *rightBtn1 = [[UIBarButtonItem alloc]initWithCustomView:right1];
    
    UIButton *right1 = [[UIButton alloc]initWithFrame:CGRectMake(0, 0, 40, 40)];
    [right1 setImage:[self getScaledImage:[UIImage imageNamed:@"btn_search.png"] scaledToMaxWidth:20] forState:UIControlStateNormal];
    [right1 addTarget:self action:@selector(rightSideMenuButtonPressed:) forControlEvents:UIControlEventTouchUpInside];
    UIBarButtonItem *rightBtn1 = [[UIBarButtonItem alloc]initWithCustomView:right1];
    
    //NSArray *barButtonArr = [[NSArray alloc]initWithObjects:rightBtn1, rightBtn2, nil];
    self.navigationItem.rightBarButtonItem = rightBtn1;
    
    appDelegate = (AppDelegate *)[UIApplication sharedApplication].delegate;
    appDelegate.currChatRoomNo = nil;
    
    NSArray *documentPaths = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES);
    NSString *documentsDir = [documentPaths objectAtIndex:0];
    self.DBName = [AppDelegate getDBName];
    self.DBPath = [documentsDir stringByAppendingPathComponent:self.DBName];
    
    self.profileImgArray = [NSMutableArray array];
    self.contentsImgArray = [NSMutableArray array];
    self.timeArray = [NSMutableArray array];
    self.writerNameArray = [NSMutableArray array];
    self.descriptionArray = [NSMutableArray array];
    self.cardSizeArray = [NSMutableArray array];
    self.snsNameArray = [NSMutableArray array];
    
    self.lastPostNo = @"1";
    self.lastTaskNo = @"1";
    
    
    if(appDelegate.use_task){
        self.segContainer.hidden=NO;
        
        [self.segContainer setFrame:CGRectMake(0, self.navigationController.navigationBar.frame.size.height + [UIApplication sharedApplication].statusBarFrame.size.height, self.view.frame.size.width, 60)];
        self.boardSegment.tintColor = [MFUtil myRGBfromHex:@"1D4696"];
        [self.boardSegment setTitle:@"일반 게시판" forSegmentAtIndex:0];
        [self.boardSegment setTitle:@"프로젝트 게시판" forSegmentAtIndex:1];
        self.boardSegment.selectedSegmentIndex=0;
        [self.boardSegment setFrame:CGRectMake(self.boardSegment.frame.origin.x, self.boardSegment.frame.origin.y, self.boardSegment.frame.size.width, 35)];
        [self.boardSegment addTarget:self action:@selector(segmentedChange:) forControlEvents:UIControlEventValueChanged];
        
        self.normalDataArray = [NSMutableArray array];
        self.projectDataArray = [NSMutableArray array];
        
        if(appDelegate.firstNormal){
            //플로팅 버튼
            //CGRect floatFrame = CGRectMake([UIScreen mainScreen].bounds.size.width-64, [UIScreen mainScreen].bounds.size.height-self.tabBarController.tabBar.frame.size.height-70, 50, 50);
            CGRect floatFrame = CGRectMake([UIScreen mainScreen].bounds.size.width-64, self.tabBarController.tabBar.frame.origin.y-self.tabBarController.tabBar.frame.size.height-70, 50, 50);
            self.addButton = [[VCFloatingActionButton alloc]initWithFrame:floatFrame normalImage:[UIImage imageNamed:@"floating_menu_home.png"] andPressedImage:[UIImage imageNamed:@"floating_menu_close.png"] withScrollview:self.collectionView naviHeight:self.navigationController.navigationBar.frame.size.height isTranslucent:YES];
            
            self.addButton.backgroundColor = [MFUtil myRGBfromHex:@"1D4696"];
            self.addButton.layer.cornerRadius = self.addButton.frame.size.width/2;
            self.addButton.clipsToBounds = YES;
            self.addButton.contentMode = UIViewContentModeScaleAspectFit;
            
            //[self.addButton setImageEdgeInsets:UIEdgeInsetsMake(0.0, 0.0, 0.0, 0.0)];
            
            self.addButton.imageArray = @[@"floating_write.png"];
            self.addButton.labelArray = @[@"새글쓰기"];
            
            self.addButton.hideWhileScrolling = YES;
            self.addButton.delegate = self;
            
            [self.view addSubview:self.addButton];
        }
        
        self.selectBoardKind=1;
        [self callWebService:@"getPostLists"];
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(0.3 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
            self.selectBoardKind=2;
            [self callWebService:@"getTaskLists"];
        });
        
    } else {
        //플로팅 버튼
        //CGRect floatFrame = CGRectMake([UIScreen mainScreen].bounds.size.width-64, [UIScreen mainScreen].bounds.size.height-self.tabBarController.tabBar.frame.size.height-70, 50, 50);
        CGRect floatFrame = CGRectMake([UIScreen mainScreen].bounds.size.width-64, self.tabBarController.tabBar.frame.origin.y-self.tabBarController.tabBar.frame.size.height-70, 50, 50);
        self.addButton = [[VCFloatingActionButton alloc]initWithFrame:floatFrame normalImage:[UIImage imageNamed:@"floating_menu_home.png"] andPressedImage:[UIImage imageNamed:@"floating_menu_close.png"] withScrollview:self.collectionView naviHeight:self.navigationController.navigationBar.frame.size.height isTranslucent:YES];
        
        self.addButton.backgroundColor = [MFUtil myRGBfromHex:@"1D4696"];
        self.addButton.layer.cornerRadius = self.addButton.frame.size.width/2;
        self.addButton.clipsToBounds = YES;
        self.addButton.contentMode = UIViewContentModeScaleAspectFit;
        
        //[self.addButton setImageEdgeInsets:UIEdgeInsetsMake(0.0, 0.0, 0.0, 0.0)];
        
        self.addButton.imageArray = @[@"floating_write.png"];
        self.addButton.labelArray = @[@"새글쓰기"];
        
        self.addButton.hideWhileScrolling = YES;
        self.addButton.delegate = self;
        
        [self.view addSubview:self.addButton];
        
        self.segContainer.hidden=YES;
        self.collectionViewTopConstraint.constant=0;
        
        self.normalDataArray = [NSMutableArray array];
        self.selectBoardKind=1;
        [self callWebService:@"getPostLists"];
    }
}

- (void)viewWillAppear:(BOOL)animated {
    [super viewWillAppear:animated];
    
    NSLog(@"CollectionViewController fromSegue : %@", self.fromSegue);
    
    if(isError){
        [self callWebService:@"getPostLists"];
        isError=NO;
    }
    
    [self.tabBarController.tabBar setHidden:NO];
}

- (void)viewDidAppear:(BOOL)animated {
    [super viewDidAppear:animated];
    
    if(self.isBoard) {
        self.navigationItem.titleView = [MFStyle navigationTitleStyle1:self.snsName];
        
    } else {
        self.navigationItem.titleView = [MFStyle navigationTitleStyle1:NSLocalizedString(@"새글 피드", @"새글 피드")];
    }
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

- (void)willAnimateRotationToInterfaceOrientation:(UIInterfaceOrientation)toInterfaceOrientation duration:(NSTimeInterval)duration{
    CGRect floatFrame = CGRectNull;
    
    if([UIDevice currentDevice].userInterfaceIdiom == UIUserInterfaceIdiomPad){
        floatFrame = CGRectMake([UIScreen mainScreen].bounds.size.width-64, self.tabBarController.tabBar.frame.origin.y-self.tabBarController.tabBar.frame.size.height-70, 50, 50);
        
    } else {
        if ((toInterfaceOrientation == UIInterfaceOrientationPortrait)||(toInterfaceOrientation == UIInterfaceOrientationPortraitUpsideDown)) {
            floatFrame = CGRectMake([UIScreen mainScreen].bounds.size.width-64, self.tabBarController.tabBar.frame.origin.y-self.tabBarController.tabBar.frame.size.height-70, 50, 50);
        } else {
            floatFrame = CGRectMake([UIScreen mainScreen].bounds.size.width-64, self.tabBarController.tabBar.frame.origin.y-self.tabBarController.tabBar.frame.size.height-40, 50, 50);
        }
    }
    
    //CGRect floatFrame = CGRectMake([UIScreen mainScreen].bounds.size.width-64, self.tabBarController.tabBar.frame.origin.y-self.tabBarController.tabBar.frame.size.height-70, 50, 50);
    self.addButton = [[VCFloatingActionButton alloc]initWithFrame:floatFrame normalImage:[UIImage imageNamed:@"floating_menu_home.png"] andPressedImage:[UIImage imageNamed:@"floating_menu_close.png"] withScrollview:self.collectionView naviHeight:self.navigationController.navigationBar.frame.size.height isTranslucent:YES];
    self.addButton.backgroundColor = [MFUtil myRGBfromHex:@"1D4696"];
    self.addButton.layer.cornerRadius = self.addButton.frame.size.width/2;
    self.addButton.clipsToBounds = YES;
    self.addButton.contentMode = UIViewContentModeScaleAspectFit;
    
    if(self.selectBoardKind==1){
        self.addButton.imageArray = @[@"floating_write.png"];
        self.addButton.labelArray = @[@"새글쓰기"];
        
    } /*else if(self.selectBoardKind==2){
        
    }*/
    
    self.addButton.hideWhileScrolling = YES;
    self.addButton.delegate = self;
    
    [self.view addSubview:self.addButton];
    
}

-(void)segmentedChange: (UISegmentedControl *)sender{
    @try{
        if(sender.selectedSegmentIndex == 0) {
            NSLog(@"일반");
            self.selectBoardKind = 1;
            
            //플로팅 버튼 변경
            self.addButton.imageArray = @[@"floating_write.png"];
            self.addButton.labelArray = @[@"새글쓰기"];
            self.addButton.hideWhileScrolling = YES;
            self.addButton.delegate = self;
            
            [self.collectionView reloadData];
            
        } else if(sender.selectedSegmentIndex == 1) {
            NSLog(@"프로젝트");
            self.selectBoardKind = 2;
            //NSLog(@"projectDataArray : %@", self.projectDataArray);
            
            //플로팅 버튼 변경
            self.addButton.imageArray = @[@"floating_write.png"];
            self.addButton.labelArray = @[@"업무생성"];
            self.addButton.hideWhileScrolling = YES;
            self.addButton.delegate = self;
            
            [self.collectionView reloadData];
        }
    } @catch(NSException *exception){
        
    }
}

#pragma mark - Floating Button Event
-(void)didSelectMenuOptionAtIndex:(NSInteger)row{
    NSLog(@"%s, row : %ld", __func__, row);
    if(row==0){
        if(self.selectBoardKind==1){
            [self createPost:nil];
        } else if(self.selectBoardKind==2){
            [self createTask];
        }
    }
}

#pragma mark -
- (void)rightSideMenuButtonPressed:(id)sender {
    //[self performSegueWithIdentifier:@"POST_SEARCH_MODAL" sender:nil];
    
    UIStoryboard *storyboard = [UIStoryboard storyboardWithName:@"Main" bundle:nil];
    SearchViewController *destination = (SearchViewController *)[storyboard instantiateViewControllerWithIdentifier:@"SearchViewController"];
    UINavigationController *navController = [[UINavigationController alloc] initWithRootViewController:destination];
    
    destination.fromSegue = @"POST_SEARCH_MODAL";
    destination.snsNo = self.snsNo;
    
    navController.modalTransitionStyle = UIModalPresentationNone;
    [self presentViewController:navController animated:YES completion:nil];
}

- (void)rightSideCancelPressed:(id)sender {
    self.navigationItem.rightBarButtonItem = [[UIBarButtonItem alloc]initWithTitle:NSLocalizedString(@"msg17", @"")
                                                                             style:UIBarButtonItemStylePlain target:self action:@selector(rightSideMenuButtonPressed:)];
    
    
    if(self.isBoard) {
        //        titleLabel.text = self.snsName;
        self.navigationItem.titleView = [MFStyle navigationTitleStyle1:self.snsName];
    } else {
        //titleLabel.text = [[NSUserDefaults standardUserDefaults]objectForKey:@"COMP_NM"];
        //titleLabel.text = NSLocalizedString(@"새글 피드", @"새글 피드");
        self.navigationItem.titleView = [MFStyle navigationTitleStyle1:NSLocalizedString(@"새글 피드", @"새글 피드")];
    }
    //    self.navigationItem.titleView = titleLabel;
}

- (IBAction)createPost:(id)sender {
    //NSLog(@"sender : %@",sender);
    if (self.snsNo != nil) {
        [self performSegueWithIdentifier:@"POST_WRITE_MODAL" sender:nil];
    }else{
        [self performSegueWithIdentifier:@"POST_SELECT_GROUP_MODAL" sender:nil];
    }
}

-(void)createTask{
    if (self.snsNo != nil) {
        UIStoryboard *storyboard = [UIStoryboard storyboardWithName:@"Main" bundle:nil];
        TaskWriteViewController *destination = (TaskWriteViewController *)[storyboard instantiateViewControllerWithIdentifier:@"TaskWriteViewController"];
        UINavigationController *navController = [[UINavigationController alloc] initWithRootViewController:destination];
        
        destination.fromSegue = @"TASK_WRITE_MODAL";
        destination.snsNo = self.snsNo;
        destination.snsName = self.snsName;
        
        [[NSNotificationCenter defaultCenter] addObserver:self
                                                 selector:@selector(noti_SaveTask:)
                                                     name:@"noti_SaveTask"
                                                   object:nil];
        
        [self presentViewController:navController animated:YES completion:nil];
    }else{
        [self performSegueWithIdentifier:@"POST_SELECT_GROUP_MODAL" sender:nil];
    }
}

- (void)tapDetected:(id)sender{
    @try{
        UIImageView *profileButton = (UIImageView *)sender;
        NSDictionary *dic = [NSDictionary dictionary];
        if(self.selectBoardKind==1){
            dic = [self.normalDataArray objectAtIndex:profileButton.tag];
        } else if(self.selectBoardKind==2){
            dic = [self.projectDataArray objectAtIndex:profileButton.tag];
        }
        
        NSString *userNo = [dic objectForKey:@"CUSER_NO"];
        CustomHeaderViewController *destination = [[CustomHeaderViewController alloc] initwithUserNo:userNo];
        destination.userNo = userNo;
        destination.fromSegue = @"POST_PROFILE_MODAL";
        
        destination.modalTransitionStyle = UIModalTransitionStyleCrossDissolve;
        [self presentViewController:destination animated:YES completion:nil];
        
    } @catch(NSException *exception){
        //[self sendToHilee:[NSString stringWithFormat:@"%s", __func__] :exception];
    }
}

-(void)callWebService:(NSString *)serviceName{
    @try{
        NSString *urlString = appDelegate.main_url;
        NSUserDefaults *prefs = [NSUserDefaults standardUserDefaults];
        NSString *myUserNo = [prefs objectForKey:@"CUSER_NO"];
        NSURL *url = [NSURL URLWithString:[urlString stringByAppendingPathComponent:serviceName]];
        NSString *paramString = nil;
        
        if([serviceName isEqualToString:@"getPostLists"]){
            self.selectBoardKind=1;
            paramString = [NSString stringWithFormat:@"stPostSeq=%@&usrNo=%@&searchNm=""",self.lastPostNo, myUserNo];
            if (self.snsNo!=nil) {
                paramString = [paramString stringByAppendingFormat:@"&snsNo=%@",self.snsNo];
            }
            
        } else if([serviceName isEqualToString:@"getTaskLists"]){
            self.selectBoardKind=2;
            paramString = [NSString stringWithFormat:@"stTaskSeq=%@&usrNo=%@&searchNm=""",self.lastTaskNo, myUserNo];
            if (self.snsNo!=nil) {
                paramString = [paramString stringByAppendingFormat:@"&snsNo=%@",self.snsNo];
            }
        }
        
        MFURLSession *session = [[MFURLSession alloc]initWithURL:url option:paramString];
        session.delegate = self;
        if ([session start]) {
            [SVProgressHUD setDefaultStyle:SVProgressHUDStyleDark];
            [SVProgressHUD setDefaultAnimationType:SVProgressHUDAnimationTypeNative];
            [SVProgressHUD show];
            
        }
        
    } @catch(NSException *exception){
        //[self sendToHilee:[NSString stringWithFormat:@"%s", __func__] :exception];
    }
}

- (void)refreshCallGetPostList{
    NSLog(@"%s",__FUNCTION__);
    @try{
        NSString *urlString = appDelegate.main_url;
        //NSString *userID = [[NSUserDefaults standardUserDefaults] objectForKey:@"USER_ID"];
        NSUserDefaults *prefs = [NSUserDefaults standardUserDefaults];
        NSString *myUserNo = [prefs objectForKey:@"CUSER_NO"];
        
        NSString *paramString = [NSString stringWithFormat:@"stPostSeq=1&usrNo=%@&searchNm=""", myUserNo];
        if (self.snsNo!=nil) {
            paramString = [paramString stringByAppendingFormat:@"&snsNo=%@",self.snsNo];
        }
        
        self.normalDataArray = [[NSMutableArray alloc]init];
        self.lastPostNo = @"1";
        
        //NSLog(@"paramString : %@",paramString);
        NSURL *url = [NSURL URLWithString:[urlString stringByAppendingPathComponent:@"getPostLists"]];
        MFURLSession *session = [[MFURLSession alloc]initWithURL:url option:paramString];
        session.delegate = self;
        if ([session start]) {
            //[SVProgressHUD show];
        }
        
    } @catch(NSException *exception){
        //[self sendToHilee:[NSString stringWithFormat:@"%s", __func__] :exception];
    }
}

#pragma mark - MFURLSessionDelegate
-(void)returnDataWithObject:(MFURLSession *)session error:(NSString *)error{
    //Progress stop..gesture recognizers added to a view
    [SVProgressHUD dismiss];
    
    @try {
        if(error!=nil || [error isEqualToString:@"(null)"]) {
            if ([error isEqualToString:@"The request timed out."]) {
                //[self callWebService:@"getPostLists"];
                
            } else {
                NSLog(@"%s \n Error Message : %@",__FUNCTION__,error);
                NSString *errorMsg =[error stringByAppendingFormat:@"\n=======WebService========\n%@",session.url.absoluteString];
                errorMsg = [errorMsg stringByAppendingFormat:@"\n=======Parameter========\n%@",session.paramString];
                errorMsg = [errorMsg stringByAppendingFormat:@"\n=======return string========\n%@",session.returnDataString];
                UIAlertController* alert = [UIAlertController alertControllerWithTitle:NSLocalizedString(@"msg18", @"")
                                                                               message:errorMsg
                                                                        preferredStyle:UIAlertControllerStyleAlert];
                
                UIAlertAction* okAction = [UIAlertAction actionWithTitle:NSLocalizedString(@"msg3", @"") style:UIAlertActionStyleDefault
                                                                 handler:^(UIAlertAction * action) {}];
                UIAlertAction* retryAction = [UIAlertAction actionWithTitle:NSLocalizedString(@"msg19", @"") style:UIAlertActionStyleDefault
                                                                    handler:^(UIAlertAction * action) { /*[self callWebService:@"getPostLists"];*/ }];
                
                [alert addAction:okAction];
                [alert addAction:retryAction];
                [self presentViewController:alert animated:YES completion:nil];
            }
        } else {
            NSString *result = [session.returnDictionary objectForKey:@"RESULT"];
            NSString *wsName = [[session.url absoluteString] lastPathComponent];
            
            if ([wsName isEqualToString:@"getPostLists"]) {
                NSMutableArray *dataSets = [session.returnDictionary objectForKey:@"DATASET"];
                NSLog(@"getPostLists dataSet : %@", dataSets);
                NSString *seq = [[NSString alloc]init];
                for(int i=1; i<=dataSets.count; i++){
                    seq = [NSString stringWithFormat:@"%d", [self.lastPostNo intValue]+i];
                }
                
                if ([result isEqualToString:@"SUCCESS"]) {
                    if ([self.lastPostNo intValue]==1) {
                        self.lastPostNo = seq;
                        self.normalDataArray = [NSMutableArray arrayWithArray:dataSets];
                        //NSLog(@"self.lastPostNo2 : %@", self.lastPostNo);
                    } else {
                        if (dataSets.count>0){
                            self.lastPostNo = seq;
                            //[self.normalDataArray addObjectsFromArray:[session.returnDictionary objectForKey:@"DATASET"]]; //thin copy 참조만
                            [self.normalDataArray addObjectsFromArray:dataSets]; //deep copy
                        }
                    }
                    
                    //if(appDelegate.firstNormal) [self.collectionView reloadData];
                    
                }else{
                    NSLog(@"%s \n Error Message : %@",__FUNCTION__,[session.returnDictionary objectForKey:@"MESSAGE"]);
                }
                
            } else if([wsName isEqualToString:@"getTaskLists"]){
                NSMutableArray *dataSets = [session.returnDictionary objectForKey:@"DATASET"];
                NSLog(@"getTaskLists dataSet : %@", dataSets);
                NSString *seq = [[NSString alloc]init];
                for(int i=1; i<=dataSets.count; i++){
                    seq = [NSString stringWithFormat:@"%d", [self.lastTaskNo intValue]+i];
                }
                
                if ([result isEqualToString:@"SUCCESS"]) {
                    if ([self.lastTaskNo intValue]==1) {
                        self.lastTaskNo = seq;
                        self.projectDataArray = [NSMutableArray arrayWithArray:dataSets];
                    } else {
                        if (dataSets.count>0){
                            self.lastTaskNo = seq;
                            [self.projectDataArray addObjectsFromArray:dataSets];
                        }
                    }
                    
                    //if(!appDelegate.firstNormal) [self.collectionView reloadData];
                    
                }else{
                    NSLog(@"%s \n Error Message : %@",__FUNCTION__,[session.returnDictionary objectForKey:@"MESSAGE"]);
                }
            }
            
            if(appDelegate.use_task){
                if(self.boardSegment.selectedSegmentIndex==0){
                    [self segmentedChange:self.boardSegment];
                }
            } else {
                [self.collectionView reloadData];
            }
            
        }
        [self stopLoading];
        
    } @catch (NSException *exception) {
        //[self sendToHilee:[NSString stringWithFormat:@"%s", __func__] :exception];
    }
}

-(void)returnError:(MFURLSession *)session error:(NSError *)error{
    //NSLog(@"error : %@", error);
    @try{
        if(error.code == -1009){
            isError=YES;
            [SVProgressHUD dismiss];
            UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"" message:@"인터넷 연결이 오프라인 상태입니다." preferredStyle:UIAlertControllerStyleAlert];
            UIAlertAction* okButton = [UIAlertAction actionWithTitle:@"확인" style:UIAlertActionStyleDefault
                                                             handler:^(UIAlertAction * action) {
                                                                 NSURL *url = [NSURL URLWithString:UIApplicationOpenSettingsURLString];
                                                                 [[UIApplication sharedApplication] openURL:url];
                                                                 
                                                                 [alert dismissViewControllerAnimated:YES completion:nil];
                                                             }];
            [alert addAction:okButton];
            [self presentViewController:alert animated:YES completion:nil];
        }
        
    } @catch(NSException *exception){
        //[self sendToHilee:[NSString stringWithFormat:@"%s", __func__] :exception];
    }
}

#pragma mark - UICollectionViewDataSource

// 컬렉션 크기 설정
- (CGSize)collectionView:(UICollectionView *)collectionView layout:(UICollectionViewLayout *)collectionViewLayout sizeForItemAtIndexPath:(NSIndexPath *)indexPath {
    //NSLog(@"%s",__func__);
    if(self.selectBoardKind==1){
        @try{
            NSDictionary *dataSetItem = [self.normalDataArray objectAtIndex:indexPath.row];
            NSArray *contentArray =[dataSetItem objectForKey:@"CONTENT"];
            //NSLog(@"contentArray : %@", contentArray);
            BOOL isText = false;
            BOOL isImg = false;
            BOOL isFile = false;
            
            NSString *value;
            for (NSDictionary *content in contentArray) {
                if ([[content objectForKey:@"TYPE"] isEqualToString:@"TEXT"]) {
                    value = [content objectForKey:@"VALUE"];
                    isText = YES;
                } else if ([[content objectForKey:@"TYPE"] isEqualToString:@"IMG"]) {
                    isImg = YES;
                } else if ([[content objectForKey:@"TYPE"] isEqualToString:@"FILE"]) {
                    isFile = YES;
                }
            }
            
            CGRect screen = [[UIScreen mainScreen]bounds];
            CGFloat screenWidth = screen.size.width;
            
            /*
             if(isText && !isImg && !isFile) {
             //                CGSize constraintSize = CGSizeMake(LABEL_DEFAUlT_WIDTH, LABEL_MAX_HEIGHT);
             //
             //                NSAttributedString *attributedText = [[NSAttributedString alloc] initWithString:[NSString urlDecodeString:value] attributes:@{NSFontAttributeName: [UIFont systemFontOfSize:14.0f]}];
             //                CGRect rect = [attributedText boundingRectWithSize:(CGSize)constraintSize options:NSStringDrawingUsesLineFragmentOrigin context:nil];
             //                CGSize newSize = rect.size;
             //
             //                float labelHeight = MAX(newSize.height, LABEL_DEFAULT_HEIGHT);
             //                return CGSizeMake(screenWidth, labelHeight);
             
             return CGSizeMake(screenWidth, 201);
             
             
             } else if(isText && isImg && !isFile){
             return CGSizeMake(screenWidth, 451);
             
             }else if(isText && !isImg && isFile){
             return CGSizeMake(screenWidth, 251);
             
             } else if(isText && isImg && isFile){
             return CGSizeMake(screenWidth, 501);
             
             } else if(!isText && isImg && !isFile){
             return CGSizeMake(screenWidth, 410);
             
             } else if(!isText && isImg && isFile){
             return CGSizeMake(screenWidth, 470);
             
             } else if(!isText && !isImg && isFile){
             return CGSizeMake(screenWidth, 210);
             
             } else {
             return CGSizeMake(screenWidth, 501);
             }
             */
            
            static CollectionViewCell *sizingCell   = nil;
            static dispatch_once_t onceToken;
            dispatch_once(&onceToken, ^{
                sizingCell = [[NSBundle mainBundle] loadNibNamed:@"CollectionViewCell" owner:self options:nil][0];
            });
            return CGSizeMake(screenWidth, [self tmpSetUpCollectionCell:sizingCell atIndexPath:indexPath]);
            
        } @catch(NSException *exception){
            //[self sendToHilee:[NSString stringWithFormat:@"%s", __func__] :exception];
        }
        
    } else if(self.selectBoardKind==2){
        @try{
            CGRect screen = [[UIScreen mainScreen]bounds];
            CGFloat screenWidth = screen.size.width;
            return CGSizeMake(screenWidth, 325);
            
        } @catch(NSException *exception){
            //[self sendToHilee:[NSString stringWithFormat:@"%s", __func__] :exception];
        }
    }
}


// 컬렉션 뷰 셀 갯수
- (NSInteger)collectionView:(UICollectionView *)collectionView numberOfItemsInSection:(NSInteger)section {
    @try{
        if(self.selectBoardKind==1){
            return [self.normalDataArray count];
            
        } else if(self.selectBoardKind==2){
            return [self.projectDataArray count];
        }
        
    } @catch(NSException *exception){
        //[self sendToHilee:[NSString stringWithFormat:@"%s", __func__] :exception];
    }
}

- (CGFloat)tmpSetUpCollectionCell:(CollectionViewCell *)cell atIndexPath:(NSIndexPath *)indexPath {
    int textH = 0;
    int imgH = 0;
    int fileH = 0;
    
    @try{
        cell.descriptionLabel.text = nil;
        cell.contentImageView.image = nil;
        cell.fileName.text = nil;
        
        if(cell!=nil && self.normalDataArray.count>0){
            NSDictionary *dataSetItem = [self.normalDataArray objectAtIndex:indexPath.item];
            NSArray *contentArray = [dataSetItem objectForKey:@"CONTENT"];
            
            //읽음카운트 20이상 줄바꿈 현상 수정
            NSDictionary *attributes = @{NSFontAttributeName: [cell.viewCntLabel font]};
            CGSize textSize = [[cell.viewCntLabel text] sizeWithAttributes:attributes];
            CGFloat strikeWidth = textSize.width;
            
            if(strikeWidth < 14.0f){
                cell.viewCntConstraint.constant = 15;
            } else {
                cell.viewCntConstraint.constant = strikeWidth+5;
            }
            cell.viewCntLabel.textAlignment = NSTextAlignmentRight;
            
            NSInteger count = [contentArray count]-1;
            NSString *description = @"";
            NSString *originImagePath =  @"";
            NSString *filePath =  @"";
            
            for (int i=(int)count; i>=0; i--) {
                NSDictionary *content = [contentArray objectAtIndex:i];
                if ([[content objectForKey:@"TYPE"] isEqualToString:@"TEXT"]) {
                    description = [NSString urlDecodeString:[content objectForKey:@"VALUE"]];
                    
                    NSString *newString = [description stringByTrimmingCharactersInSet:[NSCharacterSet whitespaceAndNewlineCharacterSet]];
                    if(![newString isEqualToString:@""]){
                        cell.descriptionLabel.text = newString;
                        [cell.descriptionLabel setNumberOfLines:5]; //글내용라인수
                        
                        CGSize maximumSize = CGSizeMake(300, 9999);
                        //CGSize expectedLabelSize = [newString sizeWithFont:cell.descriptionLabel.font constrainedToSize:maximumSize lineBreakMode:cell.descriptionLabel.lineBreakMode];
                        //NSMutableAttributedString *str = [[NSMutableAttributedString alloc] initWithString:newString];
                        UIFont *textFont = [UIFont fontWithName:@"Helvetica" size:15];
                        NSAttributedString *str = [[NSAttributedString alloc] initWithString:newString attributes:@{NSFontAttributeName: textFont}];
                        CGRect rect = [str boundingRectWithSize:(CGSize)maximumSize options:NSStringDrawingUsesLineFragmentOrigin context:nil];
                        CGSize textStringSize = rect.size;
                        
                        CGRect newFrame = cell.descriptionLabel.frame;
                        newFrame.size.height = textStringSize.height; //expectedLabelSize.height;
                        
                        int line = (int)(newFrame.size.height/cell.descriptionLabel.frame.size.height);
                        if(line==0){
                            textH = cell.descriptionLabel.frame.size.height + 10;
                        } else if(line>0 && line<6){
                            textH = cell.descriptionLabel.frame.size.height*line + 10;
                        } else {
                            textH = cell.descriptionLabel.frame.size.height*5 + 10;
                        }
                    }
                }
                if ([[content objectForKey:@"TYPE"] isEqualToString:@"IMG"]) {
                    NSDictionary *value = [content objectForKey:@"VALUE"];
                    originImagePath = [NSString urlDecodeString:[value objectForKey:@"ORIGIN"]];
                    imgH = 270;
                }
                if ([[content objectForKey:@"TYPE"] isEqualToString:@"FILE"]) {
                    filePath = [NSString urlDecodeString:[content objectForKey:@"VALUE"]];
                }
            }
            
            if(filePath!=nil && ![filePath isEqualToString:@""]){
                cell.fileView.frame = CGRectMake(cell.fileView.frame.origin.x, 350, cell.fileView.frame.size.width, 0);
                
                if(![description isEqualToString:@""] && ![originImagePath isEqualToString:@""]) {
                    cell.fileView.frame = CGRectMake(cell.fileView.frame.origin.x, cell.contentImageView.frame.origin.y+cell.contentImageView.frame.size.height+7, cell.fileView.frame.size.width, 50);
                    
                } else if([description isEqualToString:@""] && ![originImagePath isEqualToString:@""]){
                    cell.fileView.frame = CGRectMake(cell.fileView.frame.origin.x, cell.descriptionLabel.frame.origin.y+cell.contentImageView.frame.size.height+10, cell.fileView.frame.size.width, 50);
                    
                } else if(![description isEqualToString:@""] && [originImagePath isEqualToString:@""]){
                    cell.fileView.frame = CGRectMake(cell.fileView.frame.origin.x, cell.descriptionLabel.frame.origin.y+cell.descriptionLabel.frame.size.height+4, cell.fileView.frame.size.width, 50);
                    
                } else {
                    cell.fileView.frame = CGRectMake(cell.fileView.frame.origin.x, cell.descriptionLabel.frame.origin.y, cell.fileView.frame.size.width, 50);
                }
            } else {
                cell.fileView.frame = CGRectMake(cell.fileView.frame.origin.x, cell.fileView.frame.origin.y, cell.fileView.frame.size.width, 0);
            }
            
            fileH = cell.fileView.frame.size.height;
        }
        
    } @catch(NSException *exception){
        //[self sendToHilee:[NSString stringWithFormat:@"%s", __func__] :exception];
    }
    
    //NSLog(@"textH : %d, imgH : %d, fileH : %d", textH, imgH, fileH);
    return textH + imgH + fileH + 160;
}

// 컬렉션 뷰 셀 설정
- (UICollectionViewCell *)collectionView:(UICollectionView *)collectionView cellForItemAtIndexPath:(NSIndexPath *)indexPath {
    if(self.selectBoardKind==1){
        @try{
            [self.collectionView registerNib:[UINib nibWithNibName:@"CollectionViewCell" bundle:nil] forCellWithReuseIdentifier:@"CollectionViewCell"];
            CollectionViewCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:@"CollectionViewCell" forIndexPath:indexPath];
            
            cell.descriptionLabel.text = nil;
            cell.contentImageView.image = nil;
            cell.fileName.text = nil;
            
            if(cell!=nil && self.normalDataArray.count>0){
                NSDictionary *dataSetItem = [self.normalDataArray objectAtIndex:indexPath.item];
                
                NSString *profileImagePath = [NSString urlDecodeString:[dataSetItem objectForKey:@"STATUS_IMG"]]; //thumb
                NSString *snsName = [NSString urlDecodeString:[dataSetItem objectForKey:@"SNS_NM"]];
                NSString *postDate = [NSString urlDecodeString:[dataSetItem objectForKey:@"POST_DATE"]];
                NSString *writerName = [NSString urlDecodeString:[dataSetItem objectForKey:@"CUSER_NM"]];
                NSArray *contentArray = [dataSetItem objectForKey:@"CONTENT"];
                NSString *commCnt = [dataSetItem objectForKey:@"POST_COMMENT_COUNT"];
                NSString *readCnt = [dataSetItem objectForKey:@"POST_READ_COUNT"];
                
                if (![profileImagePath isEqual:@""]) {
                    MFDBHelper *dbHelper = [[MFDBHelper alloc]init];
                    UIImage *userImg = [self imageByScalingAndCroppingForSize:CGSizeMake(120, 120) :[dbHelper saveThumbImage:@"profile" :profileImagePath]];
                    [cell.userImageButton setImage:userImg forState:UIControlStateNormal];
                    
                } else{
                    [cell.userImageButton setImage:[UIImage imageNamed:@"profile_default.png"] forState:UIControlStateNormal];
                }
                
                NSDate *currentDate = [NSDate date];
                NSDateFormatter *formatter = [[NSDateFormatter alloc]init];
                formatter.dateFormat = @"yyyy-MM-dd HH:mm";
                NSString *tmp = [postDate substringToIndex:postDate.length-3];
                NSDate *regiDate = [formatter dateFromString:tmp];
                
                NSCalendar *sysCalendar = [NSCalendar currentCalendar];
                unsigned int unitFlags = NSCalendarUnitDay;
                NSDateComponents *dateComp = [sysCalendar components:unitFlags fromDate:regiDate toDate:currentDate options:0];//날짜 비교해서 차이값 추출
                NSInteger date = dateComp.day;
                
                NSString *postDateString = [[NSString alloc]init];
                if(date > 0){
                    postDateString = tmp;
                } else{
                    postDateString = [MFUtil getTimeIntervalFromDate:regiDate ToDate:currentDate];
                }
                
                cell.userNameLabel.text = writerName;
                cell.dateLabel.text = postDateString;
                cell.teamNameLabel.text = snsName;
                
                [cell.userImageButton addTarget:self action:@selector(tapDetected:) forControlEvents:UIControlEventTouchUpInside];
                cell.userImageButton.tag = indexPath.item;
                
                cell.commCntLabel.text = [NSString stringWithFormat:@"댓글 %@",commCnt];
                cell.viewCntLabel.text = [NSString stringWithFormat:@"%@",readCnt];
                
                //읽음카운트 20이상 줄바꿈 현상 수정
                NSDictionary *attributes = @{NSFontAttributeName: [cell.viewCntLabel font]};
                CGSize textSize = [[cell.viewCntLabel text] sizeWithAttributes:attributes];
                CGFloat strikeWidth = textSize.width;
                
                if(strikeWidth < 14.0f){
                    cell.viewCntConstraint.constant = 15;
                } else {
                    cell.viewCntConstraint.constant = strikeWidth+5;
                }
                cell.viewCntLabel.textAlignment = NSTextAlignmentRight;
                
                NSInteger count = [contentArray count]-1;
                NSString *description = @"";
                NSString *thumbImagePath =  @"";
                NSString *originImagePath =  @"";
                NSString *filePath =  @"";
                
                for (int i=(int)count; i>=0; i--) {
                    NSDictionary *content = [contentArray objectAtIndex:i];
                    if ([[content objectForKey:@"TYPE"] isEqualToString:@"TEXT"]) {
                        description = [NSString urlDecodeString:[content objectForKey:@"VALUE"]];
                        
                        NSString *newString = [description stringByTrimmingCharactersInSet:[NSCharacterSet whitespaceAndNewlineCharacterSet]];
                        if(![newString isEqualToString:@""]){
                            cell.descriptionLabel.text = newString;
                            //cell.descriptionLabel.text = description;
                            [cell.descriptionLabel setNumberOfLines:5]; //글내용라인수
                        }
                    }
                    if ([[content objectForKey:@"TYPE"] isEqualToString:@"IMG"]) {
                        NSDictionary *value = [content objectForKey:@"VALUE"];
                        thumbImagePath = [NSString urlDecodeString:[value objectForKey:@"THUMB"]];
                        originImagePath = [NSString urlDecodeString:[value objectForKey:@"ORIGIN"]];
                    }
                    if ([[content objectForKey:@"TYPE"] isEqualToString:@"FILE"]) {
                        filePath = [NSString urlDecodeString:[content objectForKey:@"VALUE"]];
                        NSRange range = [filePath rangeOfString:@"/" options:NSBackwardsSearch];
                        NSString *fileName = [filePath substringFromIndex:range.location+1];
                        cell.fileName.text = fileName;
                        
                        NSRange range2 = [fileName rangeOfString:@"." options:NSBackwardsSearch];
                        NSString *fileExt = [[fileName substringFromIndex:range2.location+1] lowercaseString];
                        
                        if([fileExt isEqualToString:@"jpg"]||[fileExt isEqualToString:@"jpeg"]||[fileExt isEqualToString:@"gif"]||[fileExt isEqualToString:@"png"]||[fileExt isEqualToString:@"tiff"]||[fileExt isEqualToString:@"bmp"]||[fileExt isEqualToString:@"heic"]){
                            cell.fileIcon.image = [UIImage imageNamed:@"file_img.png"];
                            
                        } else if([fileExt isEqualToString:@"mp4"]||[fileExt isEqualToString:@"mkv"]||[fileExt isEqualToString:@"wma"]||[fileExt isEqualToString:@"mov"]||[fileExt isEqualToString:@"swf"]||[fileExt isEqualToString:@"mpg"]||[fileExt isEqualToString:@"mpeg"]||[fileExt isEqualToString:@"vob"]||[fileExt isEqualToString:@"asf"]){
                            cell.fileIcon.image = [UIImage imageNamed:@"file_movie.png"];
                            
                        } else if([fileExt isEqualToString:@"mp3"]||[fileExt isEqualToString:@"wav"]||[fileExt isEqualToString:@"ogg"]||[fileExt isEqualToString:@"wma"]||[fileExt isEqualToString:@"m4a"]||[fileExt isEqualToString:@"flac"]){
                            cell.fileIcon.image = [UIImage imageNamed:@"file_music.png"];
                            
                        } else if([fileExt isEqualToString:@"psd"]){
                            cell.fileIcon.image = [UIImage imageNamed:@"file_psd.png"];
                            
                        } else if([fileExt isEqualToString:@"ai"]){
                            cell.fileIcon.image = [UIImage imageNamed:@"file_ai.png"];
                            
                        } else if([fileExt isEqualToString:@"docx"]||[fileExt isEqualToString:@"doc"]){
                            cell.fileIcon.image = [UIImage imageNamed:@"file_word.png"];
                            
                        } else if([fileExt isEqualToString:@"pptx"]||[fileExt isEqualToString:@"ppt"]){
                            cell.fileIcon.image = [UIImage imageNamed:@"file_ppt.png"];
                            
                        } else if([fileExt isEqualToString:@"xls"]||[fileExt isEqualToString:@"xlsx"]){
                            cell.fileIcon.image = [UIImage imageNamed:@"file_excel.png"];
                            
                        } else if([fileExt isEqualToString:@"pdf"]){
                            cell.fileIcon.image = [UIImage imageNamed:@"file_pdf.png"];
                            
                        } else if([fileExt isEqualToString:@"txt"]){
                            cell.fileIcon.image = [UIImage imageNamed:@"file_txt.png"];
                            
                        } else if([fileExt isEqualToString:@"hwp"]){
                            cell.fileIcon.image = [UIImage imageNamed:@"file_hwp.png"];
                            
                        } else if([fileExt isEqualToString:@"zip"]||[fileExt isEqualToString:@"rar"]||[fileExt isEqualToString:@"egg"]||[fileExt isEqualToString:@"alz"]||[fileExt isEqualToString:@"7z"]){
                            cell.fileIcon.image = [UIImage imageNamed:@"file_zip.png"];
                            
                        } else {
                            cell.fileIcon.image = [UIImage imageNamed:@"file_document.png"];
                        }
                    }
                }
                
                if (originImagePath!=nil && ![originImagePath isEqualToString:@""]) {
                    NSString *contentsImagePath = originImagePath;
                    
                    NSURL *url = [NSURL URLWithString:[contentsImagePath stringByAddingPercentEscapesUsingEncoding:NSUTF8StringEncoding]];
                    //NSLog(@"image url : %@", url);
                    NSURLSessionTask *task = [[NSURLSession sharedSession] dataTaskWithURL:url completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) {
                        if (data) {
                            UIImage *image = [UIImage imageWithData:data];
                            //NSLog(@"image : %@", image);
                            if (image) {
                                dispatch_async(dispatch_get_main_queue(), ^{
                                    cell.contentImageView.image = [self imageByScalingAndCroppingForSize:CGSizeMake(cell.contentImageView.frame.size.width, cell.contentImageView.frame.size.height) :image];
                                    cell.contentImageView.hidden = NO;
                                });
                            }
                        }
                    }];
                    [task resume];
                    
                } else{
                    cell.contentImageView.hidden = YES;
                }
                
                if(filePath!=nil && ![filePath isEqualToString:@""]){
                    //NSLog(@"filePath : %@", filePath);
                    cell.fileView.hidden = NO;
                    cell.fileIcon.hidden = NO;
                    cell.fileName.hidden = NO;
                    
                    cell.fileView.frame = CGRectMake(cell.fileView.frame.origin.x, 350, cell.fileView.frame.size.width, 0);
                    
                    if(![description isEqualToString:@""] && ![originImagePath isEqualToString:@""]) {
                        cell.fileView.frame = CGRectMake(cell.fileView.frame.origin.x, cell.contentImageView.frame.origin.y+cell.contentImageView.frame.size.height+7, cell.fileView.frame.size.width, 50);
                        
                    } else if([description isEqualToString:@""] && ![originImagePath isEqualToString:@""]){
                        cell.fileView.frame = CGRectMake(cell.fileView.frame.origin.x, cell.descriptionLabel.frame.origin.y+cell.contentImageView.frame.size.height+10, cell.fileView.frame.size.width, 50);
                        
                    } else if(![description isEqualToString:@""] && [originImagePath isEqualToString:@""]){
                        cell.fileView.frame = CGRectMake(cell.fileView.frame.origin.x, cell.descriptionLabel.frame.origin.y+cell.descriptionLabel.frame.size.height+4, cell.fileView.frame.size.width, 50);
                        
                    } else {
                        cell.fileView.frame = CGRectMake(cell.fileView.frame.origin.x, cell.descriptionLabel.frame.origin.y, cell.fileView.frame.size.width, 50);
                    }
                } else {
                    cell.fileView.hidden = YES;
                    cell.fileIcon.hidden = YES;
                    cell.fileName.hidden = YES;
                    cell.fileView.frame = CGRectMake(cell.fileView.frame.origin.x, cell.fileView.frame.origin.y, cell.fileView.frame.size.width, 0);
                }
            }
            
            return cell;
            
        } @catch(NSException *exception){
            //[self sendToHilee:[NSString stringWithFormat:@"%s", __func__] :exception];
        }
        
    } else if(self.selectBoardKind==2){
        @try{
            [self.collectionView registerNib:[UINib nibWithNibName:@"ProjectCollectionViewCell" bundle:nil] forCellWithReuseIdentifier:@"ProjectCollectionViewCell"];
            ProjectCollectionViewCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:@"ProjectCollectionViewCell" forIndexPath:indexPath];
            
            if(cell!=nil && self.projectDataArray.count>0){
                NSDictionary *dataSetItem = [self.projectDataArray objectAtIndex:indexPath.item];
                NSLog(@"dataSetItem : %@", dataSetItem);
                NSString *profileImagePath = [NSString urlDecodeString:[dataSetItem objectForKey:@"STATUS_IMG"]]; //thumb
                NSString *snsName = [NSString urlDecodeString:[dataSetItem objectForKey:@"SNS_NM"]];
                NSString *taskDate = [NSString urlDecodeString:[dataSetItem objectForKey:@"TASK_DATE"]];
                NSString *writerName = [NSString urlDecodeString:[dataSetItem objectForKey:@"CUSER_NM"]];
                NSString *taskTitle = [NSString urlDecodeString:[dataSetItem objectForKey:@"TASK_TITLE"]];
                NSString *taskStartDate = [NSString urlDecodeString:[dataSetItem objectForKey:@"TASK_START_DATE"]];
                NSString *taskEndDate = [NSString urlDecodeString:[dataSetItem objectForKey:@"TASK_END_DATE"]];
                NSNumber *taskStatus = [dataSetItem objectForKey:@"STATUS"];
                NSString *managerName = [NSString urlDecodeString:[dataSetItem objectForKey:@"MANAGER_NAME_LIST"]];
                NSNumber *taskProgress = [dataSetItem objectForKey:@"PROGRESS"];
                NSString *taskCaption = [NSString urlDecodeString:[dataSetItem objectForKey:@"TASK_CAPTION"]];
                NSArray *contentFileArray = [dataSetItem objectForKey:@"TASK_ATTACHED_FILE"];
                NSString *commCnt = [dataSetItem objectForKey:@"TASK_COMMENT_COUNT"];
                NSString *readCnt = [dataSetItem objectForKey:@"TASK_READ_COUNT"];
                
                if (![profileImagePath isEqual:@""]) {
                    MFDBHelper *dbHelper = [[MFDBHelper alloc]init];
                    UIImage *userImg = [self imageByScalingAndCroppingForSize:CGSizeMake(120, 120) :[dbHelper saveThumbImage:@"profile" :profileImagePath]];
                    [cell.userImgBtn setImage:userImg forState:UIControlStateNormal];
                    
                } else{
                    [cell.userImgBtn setImage:[UIImage imageNamed:@"profile_default.png"] forState:UIControlStateNormal];
                }
                
                NSDate *currentDate = [NSDate date];
                NSDateFormatter *formatter = [[NSDateFormatter alloc]init];
                formatter.dateFormat = @"yyyy-MM-dd HH:mm";
                NSString *tmp = [taskDate substringToIndex:taskDate.length-3];
                NSDate *regiDate = [formatter dateFromString:tmp];
                
                NSCalendar *sysCalendar = [NSCalendar currentCalendar];
                unsigned int unitFlags = NSCalendarUnitDay;
                NSDateComponents *dateComp = [sysCalendar components:unitFlags fromDate:regiDate toDate:currentDate options:0];//날짜 비교해서 차이값 추출
                NSInteger date = dateComp.day;
                
                NSString *postDateString = [[NSString alloc]init];
                if(date > 0){
                    postDateString = tmp;
                } else{
                    postDateString = [MFUtil getTimeIntervalFromDate:regiDate ToDate:currentDate];
                }
                
                cell.userName.text = writerName;
                cell.writeDate.text = postDateString;
                cell.teamName.text = snsName;
                
                [cell.userImgBtn addTarget:self action:@selector(tapDetected:) forControlEvents:UIControlEventTouchUpInside];
                cell.userImgBtn.tag = indexPath.item;
                
                cell.projectIcon.image = [self getScaledImage:[UIImage imageNamed:@"project_schedule_blue.png"] scaledToMaxWidth:25.0f];
                cell.projectTitle.text = taskTitle;
                
                NSDateFormatter *formatter2 = [[NSDateFormatter alloc] init];
                [formatter2 setDateFormat:@"yyyy-MM-dd HH:mm:ss.s"];
                
                NSDate *sDate = [formatter2 dateFromString:taskStartDate];
                NSDate *eDate = [formatter2 dateFromString:taskEndDate];
                
                NSDateFormatter *formatter3 = [[NSDateFormatter alloc] init];
                [formatter3 setDateFormat:@"yyyy-MM-dd"];
                NSString *sDateStr = [formatter3 stringFromDate:sDate];
                NSString *eDateStr = [formatter3 stringFromDate:eDate];
                
                if(taskStartDate.length<=0 && taskEndDate.length<=0){
                    cell.projectDate.text = @"미정";
                } else if(taskStartDate.length>0 && taskEndDate.length<=0){
                    cell.projectDate.text = [NSString stringWithFormat:@"%@ ~ 미정", sDateStr];
                } else if(taskStartDate.length<=0 && taskEndDate.length>0){
                    cell.projectDate.text = [NSString stringWithFormat:@"미정 ~ %@", eDateStr];
                } else {
                    cell.projectDate.text = [NSString stringWithFormat:@"%@ ~ %@", sDateStr, eDateStr];
                }
                
                
                [cell.statusBtn setBackgroundColor:[UIColor clearColor]];
                [cell.statusBtn setImage:[self getScaledImage:[UIImage imageNamed:@"project_progress.png"] scaledToMaxWidth:13.0f] forState:UIControlStateNormal];
                [cell.statusBtn setImageEdgeInsets:UIEdgeInsetsMake(0.0, 0.0, 0.0, 0.0)];
                [cell.statusBtn setTitleEdgeInsets:UIEdgeInsetsMake(0.0, 5.0, 0.0, 0.0)];
                [cell.statusBtn setTitle:@"상태" forState:UIControlStateNormal];
                
                NSString *statusStr = nil;
                if([taskStatus intValue]==1){
                    statusStr = @"요청";
                } else if([taskStatus intValue]==2){
                    statusStr = @"진행";
                } else if([taskStatus intValue]==3){
                    statusStr = @"완료";
                } else if([taskStatus intValue]==4){
                    statusStr = @"보류";
                }
                cell.statusLbl.text = statusStr;
                
                [cell.userBtn setBackgroundColor:[UIColor clearColor]];
                [cell.userBtn setImage:[self getScaledImage:[UIImage imageNamed:@"project_member.png"] scaledToMaxWidth:13.0f] forState:UIControlStateNormal];
                [cell.userBtn setImageEdgeInsets:UIEdgeInsetsMake(0.0, 0.0, 0.0, 0.0)];
                [cell.userBtn setTitleEdgeInsets:UIEdgeInsetsMake(0.0, 5.0, 0.0, 0.0)];
                [cell.userBtn setTitle:@"수행자" forState:UIControlStateNormal];
                cell.userLbl.text = managerName;
                
                [cell.proceedBtn setBackgroundColor:[UIColor clearColor]];
                [cell.proceedBtn setImage:[self getScaledImage:[UIImage imageNamed:@"project_graph.png"] scaledToMaxWidth:13.0f] forState:UIControlStateNormal];
                [cell.proceedBtn setImageEdgeInsets:UIEdgeInsetsMake(0.0, 0.0, 0.0, 0.0)];
                [cell.proceedBtn setTitleEdgeInsets:UIEdgeInsetsMake(0.0, 5.0, 0.0, 0.0)];
                [cell.proceedBtn setTitle:@"진행률" forState:UIControlStateNormal];
                
                //[cell.proceedBar setFrame:CGRectMake(cell.proceedBar.frame.origin.x, cell.proceedBar.frame.origin.y, cell.proceedBar.frame.size.width, 20)];
                [cell.ProgressView setProgress:[taskProgress intValue]*0.01 animated:NO];
                
                cell.commCnt.text = [NSString stringWithFormat:@"댓글 %@",commCnt];
                cell.viewCnt.text = [NSString stringWithFormat:@"%@",readCnt];
                
                //읽음카운트 20이상 줄바꿈 현상 수정
                NSDictionary *attributes = @{NSFontAttributeName: [cell.viewCnt font]};
                CGSize textSize = [[cell.viewCnt text] sizeWithAttributes:attributes];
                CGFloat strikeWidth = textSize.width;
                
                //                if(strikeWidth < 14.0f){
                //                    cell.viewCntConstraint.constant = 15;
                //                } else {
                //                    cell.viewCntConstraint.constant = strikeWidth+5;
                //                }
                //                cell.viewCntLabel.textAlignment = NSTextAlignmentRight;
                
            }
            
            return cell;
            
        } @catch(NSException *exception){
            //[self sendToHilee:[NSString stringWithFormat:@"%s", __func__] :exception];
        }
    }
}



- (void)collectionView:(UICollectionView *)collectionView didSelectItemAtIndexPath:(NSIndexPath *)indexPath{
    if(self.selectBoardKind==1){
        [self performSegueWithIdentifier:@"POST_DETAIL_PUSH" sender:indexPath];
    } else if(self.selectBoardKind==2){
        [self performSegueWithIdentifier:@"TASK_DETAIL_PUSH" sender:indexPath];
    }
}

#pragma mark - Push Notification
- (void)noti_NewChatPush:(NSNotification *)notification {
    @try{
        NSArray *documentPaths = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES);
        NSString *documentsDir = [documentPaths objectAtIndex:0];
        NSString *DBName = [AppDelegate getDBName];
        NSString *DBPath = [documentsDir stringByAppendingPathComponent:DBName];
        
        if(notification.userInfo!=nil){
            NSString *message = [notification.userInfo objectForKey:@"MESSAGE"];
            NSString *noti = [notification.userInfo objectForKey:@"NOTI"];
            NSDictionary *dict = [NSDictionary dictionary];
            if(noti==nil){
                NSData *jsonData = [message dataUsingEncoding:NSUTF8StringEncoding];
                NSError *error;
                dict = [NSJSONSerialization JSONObjectWithData:jsonData options:kNilOptions error:&error];
            } else {
                dict = notification.userInfo;
            }
            
            NSArray *dataSet = [dict objectForKey:@"DATASET"];
            NSString *roomNo = [[dataSet objectAtIndex:0] objectForKey:@"ROOM_NO"];
            
            NSMutableArray *roomChatArr = [NSMutableArray array];
            NSString *sqlString = [NSString stringWithFormat:@"SELECT ROOM_NM, ROOM_NOTI FROM CHAT_ROOMS WHERE ROOM_NO = %@", roomNo];
            sqlite3 *database;
            if (sqlite3_open([DBPath UTF8String], &database) == SQLITE_OK) {
                NSString *sql = sqlString;
                const char *sqlStatement = [sql UTF8String];
                sqlite3_stmt *compiledStatement;
                
                if (sqlite3_prepare_v2(database, sqlStatement, -1, &compiledStatement, NULL) == SQLITE_OK) {
                    int rowCount = 0;
                    
                    while(sqlite3_step(compiledStatement) == SQLITE_ROW) {
                        rowCount = sqlite3_column_int(compiledStatement, 0);
                        
                        NSMutableDictionary *dic = [[NSMutableDictionary alloc]init];
                        
                        for(int j=0; j<sqlite3_column_count(compiledStatement);j++){
                            NSString *keyString = [NSString stringWithUTF8String:(sqlite3_column_name(compiledStatement, j))];
                            NSString *valueString = nil;
                            if (sqlite3_column_text(compiledStatement, j)==NULL) {
                                valueString = @"null";
                            }else{
                                valueString = [NSString stringWithUTF8String:(char *)sqlite3_column_text(compiledStatement, j)];
                            }
                            [dic setObject:valueString forKey:keyString];
                        }
                        [roomChatArr addObject:dic];
                    }
                }else {
                    NSLog(@"not SQLITE_OK");
                    printf("could not prepare statement: %s\n", sqlite3_errmsg(database));
                }
                sqlite3_finalize(compiledStatement);
                
            }else{
                NSLog(@"db not open");
            }
            sqlite3_close(database);
            
            //NSLog(@"roomChatArr : %@", roomChatArr);
            UIStoryboard *storyboard = [UIStoryboard storyboardWithName:@"Main" bundle:nil];
            ChatViewController *vc = (ChatViewController *)[storyboard instantiateViewControllerWithIdentifier:@"ChatViewController"];
            
            RightSideViewController *rightViewController = [self.storyboard instantiateViewControllerWithIdentifier:@"RightSideViewController"];
            CGRect screen = [[UIScreen mainScreen]bounds];
            CGFloat screenWidth = screen.size.width;
            CGFloat screenHeight = screen.size.height;
            rightViewController.view.frame = CGRectMake(rightViewController.view.frame.origin.x, rightViewController.view.frame.origin.y, screenWidth, screenHeight);
            
            if(roomChatArr.count>0){
                NSString *roomNoti = [[roomChatArr objectAtIndex:0]objectForKey:@"ROOM_NOTI"];
                NSString *roomName = [NSString urlDecodeString:[[roomChatArr objectAtIndex:0]objectForKey:@"ROOM_NM"]];
                vc.roomNo = roomNo;
                vc.roomNoti = roomNoti;
                vc.roomName = roomName;
                rightViewController.roomNo = roomNo;
                rightViewController.roomNoti = roomNoti;
            }
            
            LGSideMenuController *container = [LGSideMenuController sideMenuControllerWithRootViewController:vc leftViewController:nil rightViewController:rightViewController];
            [container setNavigationItemTitle:[NSString urlDecodeString:vc.roomName]];
            
            //UIBarButtonItem *left = [[UIBarButtonItem alloc]initWithTitle:@"" style:UIBarButtonItemStylePlain target:self action:nil];
            //self.navigationItem.backBarButtonItem = left;
            self.navigationController.navigationBar.topItem.title = @"";
            
            NSString *sqlString2 = [NSString stringWithFormat:@"UPDATE CHAT_ROOMS SET NEW_CHAT = 0 WHERE ROOM_NO=%@;", roomNo];
            [self crudStatement:self.DBPath :sqlString2];
            
            NSString *currentClass = NSStringFromClass([[UIViewController currentViewController] class]);
            NSString *chatDetailClass = NSStringFromClass([vc class]);
            
            vc.fromSegue = @"NOTI_CHAT_DETAIL";
            vc.notiChatDic = dict;
            
            if([currentClass isEqualToString:chatDetailClass]){
                //send notification to postdetail and if noti postno equal current postno, not open modal
                [[NSNotificationCenter defaultCenter] postNotificationName:@"noti_ChatDetailView" object:nil userInfo:dict];
            } else {
                NSString *strClass = NSStringFromClass([self class]);
                if([currentClass isEqualToString:strClass]){
                    CATransition* transition = [CATransition animation];
                    transition.duration = 0.3f;
                    transition.type = kCATransitionMoveIn;
                    transition.subtype = kCATransitionFromTop;
                    [self.navigationController.view.layer addAnimation:transition forKey:kCATransition];
                    [self.navigationController pushViewController:container animated:NO];
                }
            }
        }
        
    } @catch(NSException *exception){
        //[self sendToHilee:[NSString stringWithFormat:@"%s", __func__] :exception];
    }
}

/*
 - (void)noti_TeamProfileChat:(NSNotification *)notification {
 NSLog(@"%s", __func__);
 @try{
 //그룹선택-글목록에서 푸시받았을경우
 
 NSLog(@"COLLECTIONVIEW [self.parentViewController childViewControllers] : %@", [self.parentViewController childViewControllers]);
 
 if([self.parentViewController childViewControllers].count == 1){ //> 1){
 NSString *nRoomNo = [notification.userInfo objectForKey:@"NEW_ROOM_NO"];
 NSString *nRoomNm = [NSString urlDecodeString:[notification.userInfo objectForKey:@"NEW_ROOM_NM"]];
 NSString *roomType = [notification.userInfo objectForKey:@"NEW_ROOM_TY"];
 NSArray *users = [notification.userInfo objectForKey:@"NEW_USERS"];
 
 NSUserDefaults *prefs = [NSUserDefaults standardUserDefaults];
 NSString *userNm = [prefs objectForKey:@"USER_NM"];
 NSString *decodeUserNm = [NSString urlDecodeString:userNm];
 NSString *myUserNo = [prefs objectForKey:@"CUSER_NO"];
 
 NSArray *roomNmArr = [NSArray array];
 if([nRoomNm rangeOfString:@","].location != NSNotFound){
 roomNmArr = [nRoomNm componentsSeparatedByString:@","];
 }
 //NSLog(@"roomNmArr : %@", roomNmArr);
 
 NSMutableString *resultRoomNm = [NSMutableString string];
 if(roomNmArr.count>0){
 for(int i=0; i<roomNmArr.count; i++){
 NSString *arrUserNm = [roomNmArr objectAtIndex:i];
 if(![arrUserNm isEqualToString:[NSString stringWithFormat:@"%@", decodeUserNm]]){
 [resultRoomNm appendString:[NSString stringWithFormat:@",%@", arrUserNm]];
 }
 }
 resultRoomNm = [[resultRoomNm substringFromIndex:1] mutableCopy];
 }else {
 resultRoomNm = [nRoomNm mutableCopy];
 }
 
 NSString *sqlStr = [NSString stringWithFormat:@"SELECT A.ROOM_NO ROOM_NO, A.ROOM_NM ROOM_NM, A.ROOM_NOTI ROOM_NOTI, A.NEW_CHAT NEW_CHAT, (SELECT COUNT(B.USER_NO) FROM CHAT_USERS B WHERE B.ROOM_NO = A.ROOM_NO) MEMBER_COUNT, IFNULL((SELECT DATE FROM CHATS C WHERE C.ROOM_NO = A.ROOM_NO ORDER BY C.CHAT_NO DESC LIMIT 1),'') LAST_DATE, IFNULL(B.USER_IMG,'') ROOM_IMG FROM CHAT_ROOMS A LEFT OUTER JOIN(SELECT C.ROOM_NO, GROUP_CONCAT(D.USER_IMG) USER_IMG FROM CHAT_USERS C, USERS D WHERE LENGTH(D.USER_IMG) > 0 AND D.USER_NO = C.USER_NO AND C.USER_NO != %@ GROUP BY C.ROOM_NO) B ON A.ROOM_NO = B.ROOM_NO WHERE A.ROOM_NO = %@ ORDER BY ROOM_NO ASC;", myUserNo, nRoomNo];
 
 sqlite3 *database;
 
 NSMutableArray *roomChatArr = [NSMutableArray array];
 NSMutableDictionary *dic = nil;
 
 if (sqlite3_open([self.DBPath UTF8String], &database) == SQLITE_OK) {
 NSString *sql = sqlStr;
 const char *sqlStatement = [sql UTF8String];
 sqlite3_stmt *compiledStatement;
 
 if (sqlite3_prepare_v2(database, sqlStatement, -1, &compiledStatement, NULL) == SQLITE_OK) {
 int rowCount = 0;
 
 while(sqlite3_step(compiledStatement) == SQLITE_ROW) {
 rowCount = sqlite3_column_int(compiledStatement, 0);
 
 dic = [[NSMutableDictionary alloc]init];
 
 for(int j=0; j<sqlite3_column_count(compiledStatement);j++){
 NSString *keyString = [NSString stringWithUTF8String:(sqlite3_column_name(compiledStatement, j))];
 NSString *valueString = nil;
 if (sqlite3_column_text(compiledStatement, j)==NULL) {
 valueString = @"null";
 }else{
 valueString = [NSString stringWithUTF8String:(char *)sqlite3_column_text(compiledStatement, j)];
 }
 //NSLog(@"key String : %@",keyString);
 //NSLog(@"value String : %@",valueString);
 
 [dic setObject:valueString forKey:keyString];
 }
 [roomChatArr addObject:dic];
 }
 }else {
 NSLog(@"not SQLITE_OK");
 printf("could not prepare statement: %s\n", sqlite3_errmsg(database));
 }
 sqlite3_finalize(compiledStatement);
 
 }else{
 NSLog(@"noti_TeamProfileChat db not open");
 }
 sqlite3_close(database);
 
 //NSLog(@"roomChatArr : %@", roomChatArr);
 if(roomChatArr.count==0){
 NSString *sqlString1 = [NSString stringWithFormat:@"INSERT INTO CHAT_ROOMS VALUES (%@, '%@', '%@', 1, 0, '');", nRoomNo, resultRoomNm, roomType];
 
 for (int i=0; i<users.count; i++) {
 NSString *userNo = [[users objectAtIndex:i] objectForKey:@"USER_NO"];
 NSString *userNm = [[users objectAtIndex:i] objectForKey:@"USER_NM"];
 NSString *decodeUserNm = [NSString urlDecodeString:userNm];
 NSString *userMsg = [[users objectAtIndex:i] objectForKey:@"USER_MSG"];
 NSString *decodeUserMsg = [NSString urlDecodeString:userMsg];
 NSString *userImg = [[users objectAtIndex:i] objectForKey:@"USER_IMG"];
 NSString *decodeUserImg = [NSString urlDecodeString:userImg];
 NSString *userId = [[users objectAtIndex:i] objectForKey:@"USER_ID"];
 NSString *phoneNo = [[users objectAtIndex:i] objectForKey:@"PHONE_NO"];
 NSString *deptNo = [[users objectAtIndex:i] objectForKey:@"DEPT_NO"];
 NSString *userBgImg = [[users objectAtIndex:i] objectForKey:@"USER_BG_IMG"];
 
 NSString *sqlString2 = [NSString stringWithFormat:@"INSERT OR REPLACE INTO USERS VALUES(%@, '%@', '%@', '%@','%@', '%@', '%@', '%@');", userNo, userId, decodeUserNm, decodeUserImg, decodeUserMsg, phoneNo, deptNo, userBgImg];
 NSString *sqlString3 = [NSString stringWithFormat:@"INSERT INTO CHAT_USERS VALUES (%@, %@);", nRoomNo, userNo];
 
 [self crudStatement:self.DBPath :sqlString2];
 [self crudStatement:self.DBPath :sqlString3];
 
 }
 
 [self crudStatement:self.DBPath :sqlString1];
 
 }
 
 //UIBarButtonItem *left = [[UIBarButtonItem alloc]initWithTitle:@"" style:UIBarButtonItemStylePlain target:self action:nil];
 //self.navigationItem.backBarButtonItem = left;
 self.navigationController.navigationBar.topItem.title = @"";
 ChatViewController *destination = [self.storyboard instantiateViewControllerWithIdentifier:@"ChatViewController"];
 
 RightSideViewController *rightViewController = [self.storyboard instantiateViewControllerWithIdentifier:@"RightSideViewController"];
 CGRect screen = [[UIScreen mainScreen]bounds];
 CGFloat screenWidth = screen.size.width;
 CGFloat screenHeight = screen.size.height;
 
 rightViewController.view.frame = CGRectMake(rightViewController.view.frame.origin.x, rightViewController.view.frame.origin.y, screenWidth, screenHeight);
 
 destination.roomName = resultRoomNm;
 destination.roomNo = nRoomNo;
 destination.roomNoti = @"1";
 rightViewController.roomNo = nRoomNo;
 rightViewController.roomNoti = @"1";
 
 LGSideMenuController *container = [LGSideMenuController sideMenuControllerWithRootViewController:destination leftViewController:nil rightViewController:rightViewController];
 [container setNavigationItemTitle:[NSString urlDecodeString:destination.roomName]];
 
 NSString *sqlString = [NSString stringWithFormat:@"UPDATE CHAT_ROOMS SET NEW_CHAT = 0 WHERE ROOM_NO=%@;", nRoomNo];
 [self crudStatement:self.DBPath :sqlString];
 
 [self.tabBarController.tabBar setHidden:YES];
 [self.navigationController pushViewController:container animated:YES];
 }
 
 } @catch(NSException *exception){
 //[self sendToHilee:[NSString stringWithFormat:@"%s", __func__] :exception];
 }
 }
 */

- (void)noti_FeedProfileChat:(NSNotification *)notification {
    NSLog(@"%s", __func__);
    @try{
        //글목록에서 푸시받았을경우
        if([self.parentViewController childViewControllers].count == 1){
            NSString *nRoomNo = [notification.userInfo objectForKey:@"NEW_ROOM_NO"];
            NSString *nRoomNm = [NSString urlDecodeString:[notification.userInfo objectForKey:@"NEW_ROOM_NM"]];
            NSString *roomType = [notification.userInfo objectForKey:@"NEW_ROOM_TY"];
            NSArray *users = [notification.userInfo objectForKey:@"NEW_USERS"];
            
            NSUserDefaults *prefs = [NSUserDefaults standardUserDefaults];
            NSString *userNm = [prefs objectForKey:@"USER_NM"];
            NSString *decodeUserNm = [NSString urlDecodeString:userNm];
            
            NSString *myUserNo = [prefs objectForKey:@"CUSER_NO"];
            
            NSArray *roomNmArr = [NSArray array];
            if([nRoomNm rangeOfString:@","].location != NSNotFound){
                roomNmArr = [nRoomNm componentsSeparatedByString:@","];
            }
            //NSLog(@"roomNmArr : %@", roomNmArr);
            
            NSMutableString *resultRoomNm = [NSMutableString string];
            if(roomNmArr.count>0){
                for(int i=0; i<roomNmArr.count; i++){
                    NSString *arrUserNm = [roomNmArr objectAtIndex:i];
                    if(![arrUserNm isEqualToString:[NSString stringWithFormat:@"%@", decodeUserNm]]){
                        [resultRoomNm appendString:[NSString stringWithFormat:@",%@", arrUserNm]];
                    }
                }
                resultRoomNm = [[resultRoomNm substringFromIndex:1] mutableCopy];
            }
            
            NSString *sqlStr = [NSString stringWithFormat:@"SELECT A.ROOM_NO ROOM_NO, A.ROOM_NM ROOM_NM, A.ROOM_NOTI ROOM_NOTI, A.NEW_CHAT NEW_CHAT, (SELECT COUNT(B.USER_NO) FROM CHAT_USERS B WHERE B.ROOM_NO = A.ROOM_NO) MEMBER_COUNT, IFNULL((SELECT DATE FROM CHATS C WHERE C.ROOM_NO = A.ROOM_NO ORDER BY C.CHAT_NO DESC LIMIT 1),'') LAST_DATE, IFNULL(B.USER_IMG,'') ROOM_IMG FROM CHAT_ROOMS A LEFT OUTER JOIN(SELECT C.ROOM_NO, GROUP_CONCAT(D.USER_IMG) USER_IMG FROM CHAT_USERS C, USERS D WHERE LENGTH(D.USER_IMG) > 0 AND D.USER_NO = C.USER_NO AND C.USER_NO != %@ GROUP BY C.ROOM_NO) B ON A.ROOM_NO = B.ROOM_NO WHERE A.ROOM_NO = %@ ORDER BY ROOM_NO ASC;", myUserNo, nRoomNo];
            
            sqlite3 *database;
            
            NSMutableArray *roomChatArr = [NSMutableArray array];
            NSMutableDictionary *dic = nil;
            
            if (sqlite3_open([self.DBPath UTF8String], &database) == SQLITE_OK) {
                NSString *sql = sqlStr;
                const char *sqlStatement = [sql UTF8String];
                sqlite3_stmt *compiledStatement;
                
                if (sqlite3_prepare_v2(database, sqlStatement, -1, &compiledStatement, NULL) == SQLITE_OK) {
                    int rowCount = 0;
                    
                    while(sqlite3_step(compiledStatement) == SQLITE_ROW) {
                        rowCount = sqlite3_column_int(compiledStatement, 0);
                        
                        dic = [[NSMutableDictionary alloc]init];
                        
                        for(int j=0; j<sqlite3_column_count(compiledStatement);j++){
                            NSString *keyString = [NSString stringWithUTF8String:(sqlite3_column_name(compiledStatement, j))];
                            NSString *valueString = nil;
                            if (sqlite3_column_text(compiledStatement, j)==NULL) {
                                valueString = @"null";
                            }else{
                                valueString = [NSString stringWithUTF8String:(char *)sqlite3_column_text(compiledStatement, j)];
                            }
                            //NSLog(@"key String : %@",keyString);
                            //NSLog(@"value String : %@",valueString);
                            
                            [dic setObject:valueString forKey:keyString];
                        }
                        [roomChatArr addObject:dic];
                    }
                }else {
                    NSLog(@"not SQLITE_OK");
                    printf("could not prepare statement: %s\n", sqlite3_errmsg(database));
                }
                sqlite3_finalize(compiledStatement);
                
            }else{
                NSLog(@"noti_FeedProfileChat db not open");
            }
            sqlite3_close(database);
            
            //NSLog(@"roomChatArr : %@", roomChatArr);
            if(roomChatArr.count==0){
                NSString *sqlString1 = [NSString stringWithFormat:@"INSERT INTO CHAT_ROOMS VALUES (%@, '%@', '%@', 1, 0, '');", nRoomNo, resultRoomNm, roomType];
                
                for (int i=0; i<users.count; i++) {
                    NSString *userNo = [[users objectAtIndex:i] objectForKey:@"USER_NO"];
                    NSString *userNm = [[users objectAtIndex:i] objectForKey:@"USER_NM"];
                    NSString *decodeUserNm = [NSString urlDecodeString:userNm];
                    NSString *userMsg = [[users objectAtIndex:i] objectForKey:@"USER_MSG"];
                    NSString *decodeUserMsg = [NSString urlDecodeString:userMsg];
                    NSString *userImg = [[users objectAtIndex:i] objectForKey:@"USER_IMG"];
                    NSString *decodeUserImg = [NSString urlDecodeString:userImg];
                    NSString *userId = [[users objectAtIndex:i] objectForKey:@"USER_ID"];
                    NSString *phoneNo = [[users objectAtIndex:i] objectForKey:@"PHONE_NO"];
                    NSString *deptNo = [[users objectAtIndex:i] objectForKey:@"DEPT_NO"];
                    NSString *userBgImg = [[users objectAtIndex:i] objectForKey:@"USER_BG_IMG"];
                    
                    NSString *sqlString2 = [NSString stringWithFormat:@"INSERT OR REPLACE INTO USERS VALUES(%@, '%@', '%@', '%@','%@', '%@', '%@', '%@');", userNo, userId, decodeUserNm, decodeUserImg, decodeUserMsg, phoneNo, deptNo, userBgImg];
                    NSString *sqlString3 = [NSString stringWithFormat:@"INSERT INTO CHAT_USERS VALUES (%@, %@);", nRoomNo, userNo];
                    
                    [self crudStatement:self.DBPath :sqlString2];
                    [self crudStatement:self.DBPath :sqlString3];
                    
                    //프로필 썸네일 로컬저장
                    //                NSString *tmpPath = NSTemporaryDirectory();
                    //                UIImage *thumbImage = [UIImage imageWithData:[NSData dataWithContentsOfURL:[NSURL URLWithString:[decodeUserImg stringByAddingPercentEscapesUsingEncoding:NSUTF8StringEncoding]]]];
                    //                NSData *imageData = UIImagePNGRepresentation(thumbImage);
                    //                NSString *fileName = [decodeUserImg lastPathComponent];
                    //
                    //                NSString *thumbImgPath =[tmpPath stringByAppendingPathComponent:[NSString stringWithFormat:@"mThumb_%@",fileName]];
                    //                [imageData writeToFile:thumbImgPath atomically:YES];
                }
                
                [self crudStatement:self.DBPath :sqlString1];
                
            }
            
            //UIBarButtonItem *left = [[UIBarButtonItem alloc]initWithTitle:@"" style:UIBarButtonItemStylePlain target:self action:nil];
            //self.navigationItem.backBarButtonItem = left;
            self.navigationController.navigationBar.topItem.title = @"";
            ChatViewController *destination = [self.storyboard instantiateViewControllerWithIdentifier:@"ChatViewController"];
            
            RightSideViewController *rightViewController = [self.storyboard instantiateViewControllerWithIdentifier:@"RightSideViewController"];
            CGRect screen = [[UIScreen mainScreen]bounds];
            CGFloat screenWidth = screen.size.width;
            CGFloat screenHeight = screen.size.height;
            
            rightViewController.view.frame = CGRectMake(rightViewController.view.frame.origin.x, rightViewController.view.frame.origin.y, screenWidth, screenHeight);
            
            destination.roomName = resultRoomNm;
            destination.roomNo = nRoomNo;
            destination.roomNoti = @"1";
            rightViewController.roomNo = nRoomNo;
            rightViewController.roomNoti = @"1";
            
            LGSideMenuController *container = [LGSideMenuController sideMenuControllerWithRootViewController:destination leftViewController:nil rightViewController:rightViewController];
            [container setNavigationItemTitle:[NSString urlDecodeString:destination.roomName]];
            
            NSString *sqlString = [NSString stringWithFormat:@"UPDATE CHAT_ROOMS SET NEW_CHAT = 0 WHERE ROOM_NO=%@;", nRoomNo];
            [self crudStatement:self.DBPath :sqlString];
            
            [self.tabBarController.tabBar setHidden:YES];
            [self.navigationController pushViewController:container animated:YES];
        }
        
    } @catch(NSException *exception){
        //[self sendToHilee:[NSString stringWithFormat:@"%s", __func__] :exception];
    }
}

- (void)noti_DeletePost:(NSNotification *)notification{
    NSLog(@"%s",__FUNCTION__);
    @try{
        self.lastPostNo = @"1";
        [self startLoading];
        [[NSNotificationCenter defaultCenter] removeObserver:self name:@"noti_DeletePost" object:nil];
        
    } @catch(NSException *exception){
        //[self sendToHilee:[NSString stringWithFormat:@"%s", __func__] :exception];
    }
}

- (void)noti_SavePost:(NSNotification *)notification{
    NSLog(@"%s",__FUNCTION__);
    @try{
        self.lastPostNo = @"1";
        [self startLoading];
        [[NSNotificationCenter defaultCenter] removeObserver:self name:@"noti_SavePost" object:nil];
        
    } @catch(NSException *exception){
        //[self sendToHilee:[NSString stringWithFormat:@"%s", __func__] :exception];
    }
}

- (void)noti_SaveTask:(NSNotification *)notification{
    NSLog(@"%s",__FUNCTION__);
    @try{
        self.lastTaskNo = @"1";
        [self startLoading];
        [[NSNotificationCenter defaultCenter] removeObserver:self name:@"noti_SaveTask" object:nil];
        
    } @catch(NSException *exception){
        //[self sendToHilee:[NSString stringWithFormat:@"%s", __func__] :exception];
    }
}

- (void)noti_ForceDeleteSNS:(NSNotification *)notification{
    NSLog(@"%s",__FUNCTION__);
    @try{
        self.lastPostNo = @"1";
        [self startLoading];
        
    } @catch(NSException *exception){
        //[self sendToHilee:[NSString stringWithFormat:@"%s", __func__] :exception];
    }
}

- (void)noti_RefreshFeed:(NSNotification *)notification{
    @try{
        self.lastPostNo = @"1";
        [self refreshCallGetPostList];
        
    } @catch(NSException *exception){
        //[self sendToHilee:[NSString stringWithFormat:@"%s", __func__] :exception];
    }
}

#pragma mark - UIScrollView Delegate
- (void)scrollViewDidEndDragging:(UIScrollView *)scrollView willDecelerate:(BOOL)decelerate{
    //NSLog(@"%s", __func__);
    
    @try {
        CGRect screen = [[UIScreen mainScreen]bounds];
        CGFloat screenWidth = screen.size.width;
        CGFloat screenHeight = screen.size.height;
        if ([MFUtil retinaDisplayCapable]) {
            screenHeight = screenHeight*2;
            screenWidth = screenWidth*2;
        }
        int height = 270;
        
        NSArray *tmp = [MODEL_NAME componentsSeparatedByString:@" "];
        if ([tmp[1] hasPrefix:@"5"]) {
            height = 370;
        }else if ([tmp[1] hasPrefix:@"6"] || [tmp[1] hasPrefix:@"7"] || [tmp[1] hasPrefix:@"8"] || [tmp[1] hasPrefix:@"X"]) {
            if (tmp.count==2) {
                height = 570;
            }else{
                height = 470;
            }
        }
        /*else {
         height = 660;
         }
         */
        
        if (scrollView.contentSize.height-scrollView.contentOffset.y<self.view.frame.size.height) {
            CGPoint offset = scrollView.contentOffset;
            CGRect bounds = scrollView.bounds;
            CGSize size = scrollView.contentSize;
            UIEdgeInsets inset = scrollView.contentInset;
            float y = offset.y + bounds.size.height - inset.bottom;
            float h = size.height;
            
            float reload_distance = 10;
            
            if(y > h + reload_distance) {
                //데이터로드
                if(self.selectBoardKind==1){
                    [self callWebService:@"getPostLists"];
                } else if(self.selectBoardKind==2){
                    [self callWebService:@"getTaskLists"];
                }
                
            }
        }
        [self scrollViewDidEndDragging2:scrollView willDecelerate:NO];
        
    } @catch (NSException *exception) {
        //[self sendToHilee:[NSString stringWithFormat:@"%s", __func__] :exception];
    }
}
- (void)scrollViewDidEndDragging2:(UIScrollView *)scrollView willDecelerate:(BOOL)decelerate
{
    @try {
        if(isRefresh)
        {
            return ;
        }
        
        isDragging = NO;
        if(scrollView.contentOffset.y <= -REFRESH_HEADER_DEFAULT_HEIGHT)
        {
            [self startLoading];
        }
        
    } @catch (NSException *exception) {
        //[self sendToHilee:[NSString stringWithFormat:@"%s", __func__] :exception];
    }
    
}
- (void)startLoading
{
    @try {
        //데이터새로고침
        if(self.selectBoardKind==1){
            //[self refreshCallGetPostList];
            self.lastPostNo = @"1";
            self.normalDataArray = [[NSMutableArray alloc]init];
            [self callWebService:@"getPostLists"];
            
        } else if(self.selectBoardKind==2){
            self.lastTaskNo = @"1";
            self.projectDataArray = [[NSMutableArray alloc]init];
            [self callWebService:@"getTaskLists"];
        }
        
    } @catch (NSException *exception) {
        //[self sendToHilee:[NSString stringWithFormat:@"%s", __func__] :exception];
    }
}
- (void)startLoading2
{
    isRefresh = YES;
    lbRefreshTime.hidden = NO;
    [UIView beginAnimations:nil context:NULL];
    [UIView setAnimationDuration:0.3];
    //[self.collectionView setContentInset:UIEdgeInsetsMake(REFRESH_HEADER_DEFAULT_HEIGHT, 0, 0, 0)];
    
    NSString *lbString = [NSString stringWithFormat:@"%@\n마지막으로 불러온 시간 : %@", REFRESH_TITLE_TABLE_LOAD, refreshTime];
    
    [ivRefreshArrow setHidden:YES];
    [lbRefreshTime setText:lbString];
    [spRefresh startAnimating];
    
    [UIView commitAnimations];
}
- (void)stopLoading
{
    [self performSelector:@selector(_stopLoading) withObject:nil afterDelay:1.f];
}
- (void)deleteLoading
{
    ivRefreshArrow.hidden = YES;
    lbRefreshTime.hidden = YES;
    spRefresh.hidden = YES;
    
}
- (void)_stopLoading
{
    isRefresh = NO;
    
    refreshTime = nil;
    refreshTime = [[self performSelector:@selector(_getCurrentStringTime)] copy];
    
}
- (NSString *)_getCurrentStringTime
{
    NSTimeInterval timeStamp = [[NSDate date] timeIntervalSince1970];
    NSDate *date = [NSDate dateWithTimeIntervalSince1970:timeStamp];
    NSDateFormatter *dateFormatter = [[NSDateFormatter alloc] init];
    [dateFormatter setDateFormat:REFRESH_TIME_FORMAT];
    NSString *returnString = [dateFormatter stringFromDate:date];
    return returnString;
}
- (void)_stopLoadingComplete
{
    NSString *lbString = [NSString stringWithFormat:@"%@\n마지막으로 불러온 시간 : %@", REFRESH_TITLE_TABLE_PULL, refreshTime];
    
    [ivRefreshArrow setHidden:NO];
    
    [lbRefreshTime setText:lbString];
    [spRefresh stopAnimating];
}

- (void)scrollViewDidScroll:(UIScrollView *)scrollView{
    @try {
        CGFloat scrollOffsetY = scrollView.contentOffset.y;
        //NSLog(@"scrollOffsetY : %f",scrollOffsetY);
        if(isRefresh)
        {
            if(scrollOffsetY > 0) {
                self.collectionView.contentInset = UIEdgeInsetsZero;
                
            } else if(scrollOffsetY >= - REFRESH_HEADER_DEFAULT_HEIGHT) {
                //self.collectionView.contentInset = UIEdgeInsetsMake(-scrollOffsetY, 0, 0, 0);
            }
        }
        else if(isDragging && scrollOffsetY < 0)
        {
            [UIView beginAnimations:nil context:NULL];
            if(scrollOffsetY < -REFRESH_HEADER_DEFAULT_HEIGHT)
            {
                NSString *lbString = [NSString stringWithFormat:@"%@\n마지막으로 불러온 시간 : %@", REFRESH_TITLE_TABLE_RELEASE, refreshTime];
                [lbRefreshTime setText:lbString];
                [[ivRefreshArrow layer] setTransform:CATransform3DMakeRotation(M_PI, 0, 0, 1)];
            }
            [UIView commitAnimations];
        }
    } @catch (NSException *exception) {
        //[self sendToHilee:[NSString stringWithFormat:@"%s", __func__] :exception];
    }
}
- (void)scrollViewWillBeginDragging:(UIScrollView *)scrollView{
    if(isRefresh)
    {
        return ;
    }
    
    isDragging = YES;
}


-(void) crudStatement:(NSString *)dbPath :(NSString *)crudStmt{
    NSLog(@"%s", __func__);
    sqlite3 *database;
    NSLog(@"CollectionViewController crudStmt : %@", crudStmt);
    if (sqlite3_open([dbPath UTF8String], &database) == SQLITE_OK) {
        const char *sqlStatement = [crudStmt UTF8String];
        
        sqlite3_stmt *compiledStatement;
        if (sqlite3_prepare_v2(database, sqlStatement, -1, &compiledStatement, NULL) == SQLITE_OK) {
            
            if(sqlite3_step(compiledStatement) != SQLITE_DONE){
                NSLog(@"Error updating table: %s", sqlite3_errmsg(database));
                
            }else{
                NSLog(@"CollectionViewController ok");
            }
            
            if(sqlite3_finalize(compiledStatement) != SQLITE_OK){
                NSLog(@"SQL Error : %s",sqlite3_errmsg(database));
            }
        }else {
            NSLog(@"not SQLITE_OK");
            printf("could not prepare statement: %s\n", sqlite3_errmsg(database));
        }
    }else{
        
    }
    sqlite3_close(database);
}

#pragma mark -
- (UIImage*)imageByScalingAndCroppingForSize:(CGSize)targetSize :(UIImage *)image
{
    UIImage *sourceImage = image;
    UIImage *newImage = nil;
    CGSize imageSize = sourceImage.size;
    CGFloat width = imageSize.width;
    CGFloat height = imageSize.height;
    CGFloat targetWidth = targetSize.width;
    CGFloat targetHeight = targetSize.height;
    CGFloat scaleFactor = 0.0;
    CGFloat scaledWidth = targetWidth;
    CGFloat scaledHeight = targetHeight;
    CGPoint thumbnailPoint = CGPointMake(0.0,0.0);
    
    if (CGSizeEqualToSize(imageSize, targetSize) == NO)
    {
        CGFloat widthFactor = targetWidth / width;
        CGFloat heightFactor = targetHeight / height;
        
        if (widthFactor > heightFactor)
            scaleFactor = widthFactor; // scale to fit height
        else
            scaleFactor = heightFactor; // scale to fit width
        scaledWidth  = width * scaleFactor;
        scaledHeight = height * scaleFactor;
        
        // center the image
        if (widthFactor > heightFactor)
        {
            thumbnailPoint.y = (targetHeight - scaledHeight) * 0.5;
        }
        else
            if (widthFactor < heightFactor)
            {
                thumbnailPoint.x = (targetWidth - scaledWidth) * 0.5;
            }
    }
    
    //UIGraphicsBeginImageContext(targetSize); // this will crop
    UIGraphicsBeginImageContextWithOptions(targetSize, NO, [UIScreen mainScreen].scale);
    
    CGRect thumbnailRect = CGRectZero;
    thumbnailRect.origin = thumbnailPoint;
    thumbnailRect.size.width  = scaledWidth;
    thumbnailRect.size.height = scaledHeight;
    
    [sourceImage drawInRect:thumbnailRect];
    
    newImage = UIGraphicsGetImageFromCurrentImageContext();
    if(newImage == nil)
        NSLog(@"could not scale image");
    
    //pop the context to get back to the default
    UIGraphicsEndImageContext();
    
    return newImage;
}

- (UIImage *)getScaledImage:(UIImage *)image scaledToMaxWidth:(CGFloat)width {
    CGFloat oldWidth = image.size.width;
    CGFloat oldHeight = image.size.height;
    
    CGFloat scaleFactor=1;
    
    //if (oldWidth > width) {
    scaleFactor = width / oldWidth;
    //} else  //oldWidth<width and height==0이면, scale하지 않음.
    //    return image;
    
    CGFloat newHeight = oldHeight * scaleFactor;
    CGFloat newWidth = oldWidth * scaleFactor;
    CGSize newSize = CGSizeMake(newWidth, newHeight);
    
    //NSLog(@"oldWidth : %f, oldHeight : %f", oldWidth, oldHeight);
    //NSLog(@"newWidth : %f, newHeight : %f", newWidth, newHeight);
    
    //UIGraphicsBeginImageContext(newSize);
    UIGraphicsBeginImageContextWithOptions(newSize, NO, [UIScreen mainScreen].scale);
    [image drawInRect:CGRectMake(0, 0, newSize.width, newSize.height)];
    UIImage *newImage = UIGraphicsGetImageFromCurrentImageContext();
    UIGraphicsEndImageContext();
    
    return newImage;
}

#pragma mark - Navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    if([segue.identifier isEqualToString:@"POST_WRITE_MODAL"]){
        [self.tabBarController.tabBar setHidden:YES];
        UINavigationController *destination = segue.destinationViewController;
        PostWriteTableViewController *vc = [[destination childViewControllers] objectAtIndex:0];
        vc.snsNo = self.snsNo;
        vc.snsName = self.snsName;
        vc.fromSegue = segue.identifier;
        [[NSNotificationCenter defaultCenter] addObserver:self
                                                 selector:@selector(noti_SavePost:)
                                                     name:@"noti_SavePost"
                                                   object:nil];
        
    } else if([segue.identifier isEqualToString:@"POST_SELECT_GROUP_MODAL"]){
        UINavigationController *destination = segue.destinationViewController;
        TeamListViewController *vc = [[destination childViewControllers] objectAtIndex:0];
        vc.isEdit = YES;
        vc.fromSegue = segue.identifier;
        
        if(self.selectBoardKind==1) vc.selectBoardKind=1;
        else if(self.selectBoardKind==2) vc.selectBoardKind=2;
        
        [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(noti_SavePost:) name:@"noti_SavePost" object:nil];
        [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(noti_SaveTask:) name:@"noti_SaveTask" object:nil];
        
    } else if([segue.identifier isEqualToString:@"POST_DETAIL_PUSH"]){
        //UIBarButtonItem *left = [[UIBarButtonItem alloc]initWithTitle:@"" style:UIBarButtonItemStylePlain target:self action:nil];
        //self.navigationItem.backBarButtonItem = left;
        self.navigationController.navigationBar.topItem.title = @"";
        PostDetailViewController *destination = segue.destinationViewController;
        
        NSIndexPath *indexPath = (NSIndexPath *)sender;
        destination._postNo = [[self.normalDataArray objectAtIndex:indexPath.item] objectForKey:@"POST_NO"];
        destination._snsName = [[self.normalDataArray objectAtIndex:indexPath.item] objectForKey:@"SNS_NM"];
        destination._postDate = [[self.normalDataArray objectAtIndex:indexPath.item] objectForKey:@"POST_DATE"];
        destination._readCnt = [[self.normalDataArray objectAtIndex:indexPath.item] objectForKey:@"POST_READ_COUNT"];
        destination.indexPath  = indexPath;
        destination.postInfo = [self.normalDataArray objectAtIndex:indexPath.item];
        [[NSNotificationCenter defaultCenter] addObserver:self
                                                 selector:@selector(noti_DeletePost:)
                                                     name:@"noti_DeletePost"
                                                   object:nil];
        
    } else if([segue.identifier isEqualToString:@"POST_SEARCH_MODAL"]){
        UINavigationController *nav = segue.destinationViewController;
        SearchViewController *destination = [nav.childViewControllers objectAtIndex:0];
        destination.fromSegue = segue.identifier;
        destination.snsNo = self.snsNo;
        
    } else if([segue.identifier isEqualToString:@"TASK_DETAIL_PUSH"]){
        self.navigationController.navigationBar.topItem.title = @"";
        TaskDetailViewController *destination = segue.destinationViewController;
        
        NSIndexPath *indexPath = (NSIndexPath *)sender;
        destination._taskNo = [[self.projectDataArray objectAtIndex:indexPath.item] objectForKey:@"TASK_NO"];
        destination._snsName = [[self.projectDataArray objectAtIndex:indexPath.item] objectForKey:@"SNS_NM"];
        destination._taskDate = [[self.projectDataArray objectAtIndex:indexPath.item] objectForKey:@"TASK_DATE"];
        destination._readCnt = [[self.projectDataArray objectAtIndex:indexPath.item] objectForKey:@"TASK_READ_COUNT"];
        destination.indexPath  = indexPath;
        destination.taskInfo = [self.projectDataArray objectAtIndex:indexPath.item];
        //        [[NSNotificationCenter defaultCenter] addObserver:self
        //                                                 selector:@selector(noti_DeletePost:)
        //                                                     name:@"noti_DeletePost"
        //                                                   object:nil];
        
    } else {
        
    }
}

-(void)sendToHilee:(NSString *)func :(NSException *)exception{
    UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"" message:NSLocalizedString(@"exception_msg_exception", @"exception_msg_exception") preferredStyle:UIAlertControllerStyleAlert];
    UIAlertAction* sendButton = [UIAlertAction actionWithTitle:@"관리자에게 전송" style:UIAlertActionStyleDefault
                                                       handler:^(UIAlertAction * action) {
                                                           [alert dismissViewControllerAnimated:YES completion:nil];
                                                           
                                                           UIDevice *device = [UIDevice currentDevice];
                                                           NSString *myUserNo = [[NSUserDefaults standardUserDefaults] objectForKey:@"CUSER_NO"];
                                                           NSString *dvcKind = [device modelName];
                                                           NSString *dvcVer = device.systemVersion;
                                                           
                                                           MFMessageComposeViewController *controller = [[MFMessageComposeViewController alloc] init];
                                                           if([MFMessageComposeViewController canSendText])
                                                           {
                                                               controller.body = [NSString stringWithFormat:@"%@ / %@ / %@ \n%@ \n\n%@", dvcKind, dvcVer, myUserNo, func, exception];
                                                               controller.recipients = [NSArray arrayWithObject:@"01093917822"];
                                                               controller.messageComposeDelegate = self;
                                                               [self presentViewController:controller animated:YES completion:nil];
                                                           }
                                                       }];
    
    UIAlertAction* okButton = [UIAlertAction actionWithTitle:@"확인" style:UIAlertActionStyleDefault
                                                     handler:^(UIAlertAction * action) {
                                                         [alert dismissViewControllerAnimated:YES completion:nil];
                                                     }];
    
    [alert addAction:sendButton];
    [alert addAction:okButton];
    [self presentViewController:alert animated:YES completion:nil];
}

- (void)messageComposeViewController:(nonnull MFMessageComposeViewController *)controller didFinishWithResult:(MessageComposeResult)result {
    NSString *resultString;
    switch (result) {
        case MessageComposeResultCancelled:
            resultString = NSLocalizedString(@"cancel", @"");
            break;
            
        case MessageComposeResultFailed:
        {
            resultString = NSLocalizedString(@"fail", @"");
            break;
        }
            
        case MessageComposeResultSent:
            resultString = NSLocalizedString(@"success", @"");
            break;
            
        default:
            break;
    }
    [self dismissViewControllerAnimated:YES completion:^{
        NSLog(@"%s resultString : %@",__FUNCTION__,resultString);
    }];
}

@end
