//
//  TaskFileCollectionViewCell.m
//  mfinity_sns
//
//  Created by hilee on 2018. 3. 13..
//  Copyright © 2018년 com.dbvalley. All rights reserved.
//

#import "TaskFileCollectionViewCell.h"
#import "MFDBHelper.h"

@implementation TaskFileCollectionViewCell

- (void)awakeFromNib {
    [super awakeFromNib];
    // Initialization code
}

-(void)setUpCellWithImgArray:(NSArray *)array { //TASK WIRTE & EDIT
    @try{
        NSLog(@"array : %@", array);
        CGFloat xbase = 10;
        CGFloat width = 90;
        
        for(UIView *subview in [self.scrollView subviews]) {
            [subview removeFromSuperview];
        }
        
        [self.scrollView setScrollEnabled:YES];
        [self.scrollView setShowsHorizontalScrollIndicator:NO];
        
        for(int i = 0; i < [array count]; i++) {
//            UIImage *image = [array objectAtIndex:i];
//            UIView *custom = [self createCustomViewWithImage: image];
//            custom.tag = i+1;
            
            
            UIView *custom;
            if([[array objectAtIndex:i] isKindOfClass:NSClassFromString(@"NSString")]){
                NSString *imgUrl = [array objectAtIndex:i];
                NSLog(@"setUpCellWithImgArray imgUrl : %@", imgUrl);
                custom = [self createCustomViewWithUrl:imgUrl];
                custom.tag = i+1;
                
            } else {
                NSLog(@"setUpCellWithImgArray images : %@", self.images);
                UIImage *image = [array objectAtIndex:i];
                custom = [self createCustomViewWithImage: image];
                custom.tag = i+1;
            }
            
            self.images = array;
            
            if([self.fromSegue isEqualToString:@"TASK_WRITE_FILE_CELL"]){
                UIButton *button = [[UIButton alloc]initWithFrame:CGRectMake(custom.frame.size.width-32, custom.frame.size.height-32, 30, 30)];
                button.layer.cornerRadius = button.frame.size.width/2;
                button.clipsToBounds = YES;
                button.contentMode = UIViewContentModeScaleAspectFill;
                button.backgroundColor = [MFUtil myRGBfromHex:@"1D4696"];
                button.layer.borderColor = [[UIColor lightGrayColor] CGColor];
                button.layer.borderWidth = 0.3;
                button.tag = i+1;
                [button setTitle:@"X" forState:UIControlStateNormal];
                [button addTarget:self action:@selector(imgDeleteClick:) forControlEvents:UIControlEventTouchUpInside];
                [custom addSubview:button];
            }
            
            [self.scrollView addSubview:custom];
            [custom setFrame:CGRectMake(xbase, 7, width, 90)];
            xbase += 10 + width;
        }
        
        [self.scrollView setContentSize:CGSizeMake(xbase, self.scrollView.frame.size.height)];
        self.scrollView.delegate = self;
        
    } @catch(NSException *exception){
        
    }
    
}

- (void)setUpCellWithArray:(NSArray *)array { //TASK DETAIL
    @try{
        CGFloat xbase = 10;
        CGFloat width = 90;
        
        for(UIView *subview in [self.scrollView subviews]) {
            [subview removeFromSuperview];
        }
        
        [self.scrollView setScrollEnabled:YES];
        [self.scrollView setShowsHorizontalScrollIndicator:NO];
        
        for(int i = 0; i < [array count]; i++) {
            //        UIImage *image = [array objectAtIndex:i];
            //        UIView *custom = [self createCustomViewWithImage: image];
            //        [self.scrollView addSubview:custom];
            //        [custom setFrame:CGRectMake(xbase, 7, width, 90)];
            //        xbase += 10 + width;
            
            //NSLog(@"[array objectAtIndex:i] class : %@", [[array objectAtIndex:i] class]);
        
            UIView *custom;
            if([[array objectAtIndex:i] isKindOfClass:NSClassFromString(@"NSString")]){
                NSString *imgUrl = [array objectAtIndex:i];
                NSLog(@"setUpCellWithArray imgUrl : %@", imgUrl);
                custom = [self createCustomViewWithUrl:imgUrl];
                custom.tag = i+1;
                
            } else {
                NSLog(@"setUpCellWithArray images : %@", self.images);
                UIImage *image = [array objectAtIndex:i];
                custom = [self createCustomViewWithImage: image];
                custom.tag = i+1;
            }
            
            
            if([self.fromSegue isEqualToString:@"TASK_WRITE_FILE_CELL"]){
                UIButton *button = [[UIButton alloc]initWithFrame:CGRectMake(custom.frame.size.width-32, custom.frame.size.height-32, 30, 30)];
                button.layer.cornerRadius = button.frame.size.width/2;
                button.clipsToBounds = YES;
                button.contentMode = UIViewContentModeScaleAspectFill;
                button.backgroundColor = [MFUtil myRGBfromHex:@"1D4696"];
                button.layer.borderColor = [[UIColor lightGrayColor] CGColor];
                button.layer.borderWidth = 0.3;
                button.tag = i+1;
                [button setTitle:@"X" forState:UIControlStateNormal];
                [button addTarget:self action:@selector(imgDeleteClick:) forControlEvents:UIControlEventTouchUpInside];
                [custom addSubview:button];
            }
            
            [self.scrollView addSubview:custom];
            [custom setFrame:CGRectMake(xbase, 7, width, 90)];
            custom.layer.borderColor = [[UIColor lightGrayColor] CGColor];
            custom.layer.borderWidth = 0.3;
            xbase += 10 + width;
        }
        
        [self.scrollView setContentSize:CGSizeMake(xbase, self.scrollView.frame.size.height)];
        self.scrollView.delegate = self;
    } @catch(NSException *exception){
        
    }
    
}

- (UIImage *)checkFileType:(NSString *)filePath{
    @try{
        UIImage *resultImg = nil;
        NSRange range = [filePath rangeOfString:@"/" options:NSBackwardsSearch];
        NSString *fileName = [filePath substringFromIndex:range.location+1];
        
        NSRange range2 = [fileName rangeOfString:@"." options:NSBackwardsSearch];
        NSString *fileExt = [[fileName substringFromIndex:range2.location+1] lowercaseString];
        
        if([fileExt isEqualToString:@"jpg"]||[fileExt isEqualToString:@"jpeg"]||[fileExt isEqualToString:@"gif"]||[fileExt isEqualToString:@"png"]||[fileExt isEqualToString:@"tiff"]||[fileExt isEqualToString:@"bmp"]||[fileExt isEqualToString:@"heic"]){
            resultImg = [UIImage imageNamed:@"file_img.png"];
            
        } else if([fileExt isEqualToString:@"mp4"]||[fileExt isEqualToString:@"mkv"]||[fileExt isEqualToString:@"wma"]||[fileExt isEqualToString:@"mov"]||[fileExt isEqualToString:@"swf"]||[fileExt isEqualToString:@"mpg"]||[fileExt isEqualToString:@"mpeg"]||[fileExt isEqualToString:@"vob"]||[fileExt isEqualToString:@"asf"]){
            resultImg = [UIImage imageNamed:@"file_movie.png"];
            
        } else if([fileExt isEqualToString:@"mp3"]||[fileExt isEqualToString:@"wav"]||[fileExt isEqualToString:@"ogg"]||[fileExt isEqualToString:@"wma"]||[fileExt isEqualToString:@"m4a"]||[fileExt isEqualToString:@"flac"]){
            resultImg = [UIImage imageNamed:@"file_music.png"];
            
        } else if([fileExt isEqualToString:@"psd"]){
            resultImg = [UIImage imageNamed:@"file_psd.png"];
            
        } else if([fileExt isEqualToString:@"ai"]){
            resultImg = [UIImage imageNamed:@"file_ai.png"];
            
        } else if([fileExt isEqualToString:@"docx"]||[fileExt isEqualToString:@"doc"]){
            resultImg = [UIImage imageNamed:@"file_word.png"];
            
        } else if([fileExt isEqualToString:@"pptx"]||[fileExt isEqualToString:@"ppt"]){
            resultImg = [UIImage imageNamed:@"file_ppt.png"];
            
        } else if([fileExt isEqualToString:@"xls"]||[fileExt isEqualToString:@"xlsx"]){
            resultImg = [UIImage imageNamed:@"file_excel.png"];
            
        } else if([fileExt isEqualToString:@"pdf"]){
            resultImg = [UIImage imageNamed:@"file_pdf.png"];
            
        } else if([fileExt isEqualToString:@"txt"]){
            resultImg = [UIImage imageNamed:@"file_txt.png"];
            
        } else if([fileExt isEqualToString:@"hwp"]){
            resultImg = [UIImage imageNamed:@"file_hwp.png"];
            
        } else if([fileExt isEqualToString:@"zip"]||[fileExt isEqualToString:@"rar"]||[fileExt isEqualToString:@"egg"]||[fileExt isEqualToString:@"alz"]||[fileExt isEqualToString:@"7z"]){
            resultImg = [UIImage imageNamed:@"file_zip.png"];
            
        } else {
            resultImg = [UIImage imageNamed:@"file_document.png"];
        }
        
        return resultImg;
        
    } @catch(NSException *exception){
        
    }
    
}

//hilee Custom
-(UIView *)createCustomViewWithUrl:(NSString *)imgUrl {
    @try{
//        self.images = [NSMutableArray array];
//        self.imgDataArr = [NSMutableArray array];
//        self.imgNameArr = [NSMutableArray array];
        
        UIView *custom = [[UIView alloc]initWithFrame:CGRectMake(0, 0, 90, 90)];
        UIImageView *imageView = [[UIImageView alloc]initWithFrame:CGRectMake(0, 0, 90, 90)];
        UILabel *fileNameLabel = [[UILabel alloc]initWithFrame:CGRectMake(10, imageView.frame.size.height-40, imageView.frame.size.width-20, 30)];
        UIImageView *imageView2 = [[UIImageView alloc]initWithFrame:CGRectMake((imageView.frame.size.width/2)-(30/2), fileNameLabel.frame.origin.y-30, 30, 30)];
        
        NSRange range = [imgUrl rangeOfString:@"/" options:NSBackwardsSearch];
        NSString *fileName = [imgUrl substringFromIndex:range.location+1];
        
        NSRange range2 = [fileName rangeOfString:@"." options:NSBackwardsSearch];
        NSString *fileExt = [[fileName substringFromIndex:range2.location+1] lowercaseString];
        
        if([fileExt isEqualToString:@"jpg"]||[fileExt isEqualToString:@"jpeg"]||[fileExt isEqualToString:@"gif"]||[fileExt isEqualToString:@"png"]||[fileExt isEqualToString:@"tiff"]||[fileExt isEqualToString:@"bmp"]||[fileExt isEqualToString:@"heic"]){
            
            imageView.hidden=NO;
            imageView2.hidden=YES;
            fileNameLabel.hidden=YES;
            
            MFDBHelper *dbHelper = [[MFDBHelper alloc]init];
            UIImage *attachImg = [self imageByScalingAndCroppingForSize:CGSizeMake(90, 90):[dbHelper saveThumbImage:@"task":imgUrl]];
            NSLog(@"attachImg : %@", attachImg);
            
            NSData * data = UIImageJPEGRepresentation(attachImg, 0.3);
            
//            [self.images addObject:attachImg];
//            [self.imgDataArr addObject:data];
//            [self.imgNameArr addObject:[imgUrl lastPathComponent]];

            //NSLog(@"images : %@", self.images);
            
            [imageView setImage:attachImg];
            [custom addSubview:imageView];
            
        } else {
            imageView.hidden=YES;
            imageView2.hidden=NO;
            fileNameLabel.hidden=NO;
            
            fileNameLabel.text = [imgUrl lastPathComponent];
            [fileNameLabel setFont:[UIFont systemFontOfSize:11]];
            fileNameLabel.lineBreakMode = NSLineBreakByTruncatingMiddle;
            
            UIImage *fileImg = [self checkFileType:imgUrl];
            [imageView2 setImage:fileImg];
            
            NSData * data = UIImageJPEGRepresentation(fileImg, 0.3);
            
//            [self.images addObject:fileImg];
//            [self.imgDataArr addObject:data];
//            [self.imgNameArr addObject:[imgUrl lastPathComponent]];
            
            [custom addSubview:imageView2];
            [custom addSubview:fileNameLabel];
        }
        [custom setBackgroundColor:[UIColor clearColor]];
        
        UITapGestureRecognizer *singleFingerTap = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(handleSingleTap:)];
        [custom addGestureRecognizer:singleFingerTap];
        
        return custom;
        
    } @catch(NSException *exception){
        
    }
    
}

-(UIView *)createCustomViewWithImage:(UIImage *)image {
    @try{
        UIView *custom = [[UIView alloc]initWithFrame:CGRectMake(0, 0, 90, 90)];
        UIImageView *imageView = [[UIImageView alloc]initWithFrame:CGRectMake(0, 0, 90, 90)];
        [imageView setImage:[self imageByScalingAndCroppingForSize:CGSizeMake(90, 90):image]];
        
        [custom addSubview:imageView];
        [custom setBackgroundColor:[UIColor clearColor]];
        
        UITapGestureRecognizer *singleFingerTap = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(handleSingleTap:)];
        [custom addGestureRecognizer:singleFingerTap];
        
        return custom;
        
    } @catch(NSException *exception){
        
    }
    
}

- (void)scrollViewDidEndDragging:(UIScrollView *)scrollView willDecelerate:(BOOL)decelerate {
    //[self containingScrollViewDidEndDragging:scrollView];
}

//The event handling method
- (void)handleSingleTap:(UITapGestureRecognizer *)recognizer {
    NSLog(@"clicked");
    
    UIView *selectedView = (UIView *)recognizer.view;
    [_cellDelegate cellSelected:selectedView];
}

-(void)imgDeleteClick:(UIButton *)sender{
    @try{
//        NSLog(@"imgDeleteClick images : %@", self.images);
        NSLog(@"sender.tag : %lu", sender.tag);
        NSLog(@"array : %@", self.images);
        
//        if(_isEdit){
            [_cellDelegate editImgDeleteClick:sender :self.images :self.imgDataArr :self.imgNameArr]; //업무 수정
//        } else {
//            [_cellDelegate imgDeleteClick:sender]; //업무 생성
//        }
    } @catch(NSException *exception){
        
    }
}

- (UIImage*)imageByScalingAndCroppingForSize:(CGSize)targetSize :(UIImage *)image {
    UIImage *sourceImage = image;
    UIImage *newImage = nil;
    CGSize imageSize = sourceImage.size;
    CGFloat width = imageSize.width;
    CGFloat height = imageSize.height;
    CGFloat targetWidth = targetSize.width;
    CGFloat targetHeight = targetSize.height;
    CGFloat scaleFactor = 0.0;
    CGFloat scaledWidth = targetWidth;
    CGFloat scaledHeight = targetHeight;
    CGPoint thumbnailPoint = CGPointMake(0.0,0.0);
    
    if (CGSizeEqualToSize(imageSize, targetSize) == NO)
    {
        CGFloat widthFactor = targetWidth / width;
        CGFloat heightFactor = targetHeight / height;
        
        if (widthFactor > heightFactor)
            scaleFactor = widthFactor; // scale to fit height
        else
            scaleFactor = heightFactor; // scale to fit width
        scaledWidth  = width * scaleFactor;
        scaledHeight = height * scaleFactor;
        
        // center the image
        if (widthFactor > heightFactor)
        {
            thumbnailPoint.y = (targetHeight - scaledHeight) * 0.5;
        }
        else
            if (widthFactor < heightFactor)
            {
                thumbnailPoint.x = (targetWidth - scaledWidth) * 0.5;
            }
    }
    
    //UIGraphicsBeginImageContext(targetSize); // this will crop
    UIGraphicsBeginImageContextWithOptions(targetSize, NO, [UIScreen mainScreen].scale);
    
    CGRect thumbnailRect = CGRectZero;
    thumbnailRect.origin = thumbnailPoint;
    thumbnailRect.size.width  = scaledWidth;
    thumbnailRect.size.height = scaledHeight;
    
    [sourceImage drawInRect:thumbnailRect];
    
    newImage = UIGraphicsGetImageFromCurrentImageContext();
    if(newImage == nil)
        NSLog(@"could not scale image");
    
    //pop the context to get back to the default
    UIGraphicsEndImageContext();
    return newImage;
}

@end
